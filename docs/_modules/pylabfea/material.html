
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pylabfea.material &#8212; pyLabFEA 4.1.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pyLabFEA 4.1.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pylabfea.material</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pylabfea.material</h1><div class="highlight"><pre>
<span></span><span class="c1"># Module pylabfea.material</span>
<span class="sd">&#39;&#39;&#39;Module pylabfea.material introduces class ``Material`` that contains attributes and methods</span>
<span class="sd">needed for elastic-plastic material definitions in FEA. It also enables the training of </span>
<span class="sd">machine learning algorithms as yield functions for plasticity.</span>
<span class="sd">The module pylabfea.model is used to calculate mechanical properties of a defined material </span>
<span class="sd">under various loading conditions.</span>

<span class="sd">uses NumPy, ScipPy, MatPlotLib, sklearn, pickle, and pyLabFEA.model</span>

<span class="sd">Version: 4.1 (2022-01-23)</span>
<span class="sd">Authors: Alexander Hartmaier, Ronak Shoghi, ICAMS/Ruhr University Bochum, Germany</span>
<span class="sd">Email: alexander.hartmaier@rub.de</span>
<span class="sd">distributed under GNU General Public License (GPLv3)&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">pylabfea.basic</span> <span class="kn">import</span> <span class="n">a_vec</span><span class="p">,</span> <span class="n">b_vec</span><span class="p">,</span> \
                           <span class="n">eps_eq</span><span class="p">,</span> <span class="n">sig_polar_ang</span><span class="p">,</span> <span class="n">ptol</span><span class="p">,</span> \
                           <span class="n">sig_eq_j2</span><span class="p">,</span> <span class="n">sig_cyl2princ</span><span class="p">,</span> <span class="n">sig_princ</span><span class="p">,</span> <span class="n">sig_dev</span>
<span class="kn">from</span> <span class="nn">pylabfea.model</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">pylabfea.training</span> <span class="kn">import</span> <span class="n">load_cases</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">root_scalar</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">fsolve</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">svm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">getpass</span>

<span class="s1">&#39;==========================&#39;</span>
<span class="s1">&#39;define class for materials&#39;</span>
<span class="s1">&#39;==========================&#39;</span>
<div class="viewcode-block" id="Material"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material">[docs]</a><span class="k">class</span> <span class="nc">Material</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Define class for Materials including material parameters (attributes), constitutive relations (methods)</span>
<span class="sd">    and derived properties und various loading conditions (dictionary)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of material (optional, default: &#39;Material&#39;)</span>
<span class="sd">    num : int</span>
<span class="sd">        Material number (optional, default: 1)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name    : str</span>
<span class="sd">        Name of material</span>
<span class="sd">    num     : int</span>
<span class="sd">        Material number</span>
<span class="sd">    sy      : float</span>
<span class="sd">        Yield strength</span>
<span class="sd">    ML_yf   : Boolean</span>
<span class="sd">        Existence of trained machine learning (ML) yield function (default: False)</span>
<span class="sd">    ML_grad : Boolean</span>
<span class="sd">        Existence of trained ML gradient (default: False)</span>
<span class="sd">    tresca  : Boolean</span>
<span class="sd">        Indicate if Tresca equivalent stress should be used (default: False)</span>
<span class="sd">    hill_3p  : Boolean</span>
<span class="sd">        Indicates whether 3-paramater Hill model should be used (default: False)</span>
<span class="sd">    hill_6p  : Boolean</span>
<span class="sd">        Indicates whether 6-paramater Hill model should be used (default: False)</span>
<span class="sd">    barlat  : Boolean</span>
<span class="sd">        Indicate if Barlat equivalent stress should be used (default: False)</span>
<span class="sd">    msg     : dictionary</span>
<span class="sd">        Messages returned</span>
<span class="sd">    prop    : dictionary</span>
<span class="sd">        Derived properties under defined load paths</span>
<span class="sd">    propJ2  : dictionary</span>
<span class="sd">        Derived properties in form of J2 equivalent stress</span>
<span class="sd">    sigeps  : dictionary</span>
<span class="sd">        Data of stress-strain curves under defined load paths</span>
<span class="sd">    C11, C12, C44 : float</span>
<span class="sd">        Anisotropic elastic constants</span>
<span class="sd">    E, nu  : float</span>
<span class="sd">        Isotropic elastic constants, Young modulus and Poisson number</span>
<span class="sd">    msparam : ditionary</span>
<span class="sd">        Dicitionary with microstructural parameters assigned to this material</span>
<span class="sd">    whdat   : Boolean</span>
<span class="sd">        Indicates existence of work hardening data</span>
<span class="sd">    txdat   : Boolean</span>
<span class="sd">        Indicates existance of data for different textures</span>
<span class="sd">    Ndof   : int</span>
<span class="sd">        degress of freedom for yield function, mandatory: 1:seq, 2:theta; optional: 3:work_hard, 4:texture)</span>
<span class="sd">        </span>
<span class="sd">    Keyword Arguments</span>
<span class="sd">    -----------------</span>
<span class="sd">    prop-propJ2 :</span>
<span class="sd">        Store properties of material (Hill-formulation or J2 formulation) in sub-dictonaries:</span>
<span class="sd">        &#39;stx&#39; (tensile horiz. stress), &#39;sty&#39; (tensile vert. stress),</span>
<span class="sd">        &#39;et2&#39; (equibiaxial tensile strain), &#39;ect&#39; (pure shear)</span>
<span class="sd">    stx-sty-et2-ect  : sub-dictionaries</span>
<span class="sd">        Store data for &#39;ys&#39; (float - yield strength), seq (array - eqiv. stress),</span>
<span class="sd">        &#39;eeq&#39; (array - equiv. total strain), &#39;peeq&#39; (array - equiv. plastic strain),</span>
<span class="sd">        &#39;sytel&#39; (str - line style for plot), &#39;name&#39; (str - name in legend)</span>
<span class="sd">    sigeps :</span>
<span class="sd">        Store tensorial stress strain data in sub-directories;</span>
<span class="sd">        Contains data for &#39;sig&#39; (2d-array - stress), &#39;eps&#39; (2d-array - strain),</span>
<span class="sd">        &#39;epl&#39; (2d-array - plastic strain)</span>
<span class="sd">    msparam :</span>
<span class="sd">        Store data on microstructure parameters: &#39;Npl&#39;, &#39;Nlc, &#39;Ntext&#39;, &#39;texture&#39;, &#39;peeq_max&#39;, &#39;work_hard&#39;, &#39;flow_stress&#39; </span>
<span class="sd">        are obtained from data analysis module. Other parameters can be added.</span>
<span class="sd">    msg :</span>
<span class="sd">        Messages that can be retrieved: &#39;yield_fct&#39;, &#39;gradient&#39;, &#39;nsteps&#39;, &#39;equiv&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Methods</span>
    <span class="c1">#elasticity: define elastic material parameters C11, C12, C44</span>
    <span class="c1">#plasticity: define plastic material parameter sy, khard</span>
    <span class="c1">#epl_dot: calculate plastic strain rate</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Material&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sy</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Elasticity will be considered unless sy is set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># use conventional plasticity unless trained ML functions exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ML_grad</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># use conventional gradient unless ML function exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tresca</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># use J2 or Hill equivalent stress unless defined otherwise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barlat</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Use Barlat equiv. stress if parameters are given</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># parameters for primary microstructure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hill_6p</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># dimensionality of stress space to be considered in ML flow rules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_method</span> <span class="o">=</span> <span class="s1">&#39;brentq&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;yield_fct&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;gradient&#39;</span>  <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;nsteps&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;equiv&#39;</span>  <span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="p">{</span>    <span class="c1"># stores strength and stress-strain data along given load paths</span>
            <span class="s1">&#39;stx&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ys&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;seq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;peeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;style&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
            <span class="s1">&#39;sty&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ys&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;seq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;peeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;style&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
            <span class="s1">&#39;et2&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ys&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;seq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;peeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;style&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
            <span class="s1">&#39;ect&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ys&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;seq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;peeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;style&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propJ2</span> <span class="o">=</span> <span class="p">{</span>    <span class="c1"># stores J2 equiv strain data along given load paths</span>
            <span class="s1">&#39;stx&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ys&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;seq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;peeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
            <span class="s1">&#39;sty&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ys&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;seq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;peeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
            <span class="s1">&#39;et2&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ys&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;seq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;peeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
            <span class="s1">&#39;ect&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ys&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;seq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;peeq&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigeps</span> <span class="o">=</span> <span class="p">{</span>    <span class="c1"># calculates strength and stress strain data along given load paths</span>
            <span class="s1">&#39;stx&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sig&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eps&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;epl&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
            <span class="s1">&#39;sty&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sig&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eps&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;epl&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
            <span class="s1">&#39;et2&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sig&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eps&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;epl&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
            <span class="s1">&#39;ect&#39;</span>   <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sig&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;eps&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;epl&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
        <span class="p">}</span>

    <span class="c1">#=================================================================</span>
    <span class="c1"># subroutines for elastic and plastic material behavior</span>
    <span class="c1">#=================================================================</span>
<div class="viewcode-block" id="Material.response"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.response">[docs]</a>    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">epl</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">CV</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate non-linear material response to deformation defined by load step, </span>
<span class="sd">        corresponds to user material function.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sig : (6,) array</span>
<span class="sd">            Voigt stress tensor at start of load step (=end of previous load step)</span>
<span class="sd">        epl : (6,) array</span>
<span class="sd">            Voigt plastic strain tensor at start of load step</span>
<span class="sd">        deps : (6,) array</span>
<span class="sd">            Voigt strain tensor defining deformation (=load step)</span>
<span class="sd">        CV : (6,6) array</span>
<span class="sd">            Voigt elastic tensor</span>
<span class="sd">        maxit : int</span>
<span class="sd">            Maximum number of iteration steps (optional, default= 5)</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fy1 : real</span>
<span class="sd">            Yield function at end of load step (indicates whether convergence is reached)</span>
<span class="sd">        sig : (6,) array</span>
<span class="sd">            Voigt stress tensor at end of load step</span>
<span class="sd">        depl : (6,) array</span>
<span class="sd">            Voigt tensor of plastic strain increment at end of load step</span>
<span class="sd">        grad_stiff : (6,6) array</span>
<span class="sd">            Tangent material stiffness matrix (d_sig/d_eps) at end of load step</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">sh</span><span class="o">!=</span><span class="p">(</span><span class="mi">6</span><span class="p">,)</span> <span class="ow">and</span> <span class="n">sh</span><span class="o">!=</span><span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only individual stress tensors supported in material.response. Shape of argument is </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sh</span><span class="p">))</span>
        <span class="c1">#initialize quantities needed</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="c1"># produce copy of sig to avoid changes to original</span>
        <span class="n">depl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c1"># initialize plastic strain increment</span>
        <span class="n">peeq</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">epl</span><span class="p">)</span> <span class="c1"># equiv. plastic strain at start of step</span>
        <span class="n">toler</span> <span class="o">=</span> <span class="n">ptol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_sflow</span><span class="p">(</span><span class="n">peeq</span><span class="p">)</span>
        <span class="n">dsig</span> <span class="o">=</span> <span class="n">CV</span> <span class="o">@</span> <span class="n">deps</span>   <span class="c1"># predictor of stress increment</span>
        <span class="n">st_scal</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">niter</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1">#evaluate yield function for elastic predictor step</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span><span class="p">:</span>
            <span class="n">fy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_full_yf</span><span class="p">(</span><span class="n">sig</span><span class="o">+</span><span class="n">dsig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">sig</span><span class="o">+</span><span class="n">dsig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fy1</span> <span class="o">&lt;</span> <span class="n">toler</span><span class="p">:</span>
            <span class="c1"># purely elastic load step</span>
            <span class="n">sig</span> <span class="o">+=</span> <span class="n">dsig</span> <span class="c1"># update stress</span>
            <span class="n">grad_stiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">CV</span><span class="p">)</span>  <span class="c1"># gradient stiffness is elastic stiffness</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># elastic predictor step reaches to plastic regime</span>
            <span class="n">fy0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>  <span class="c1"># yield fct. at start of load step</span>
            <span class="k">if</span> <span class="n">fy0</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">:</span>
                <span class="c1"># load step starts in elastic regime and ends in plastic regime</span>
                <span class="c1"># must be splitted into elastic and plastic parts</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span><span class="p">:</span>
                    <span class="c1">#for categorial ML yield function, calculate fy0 as distance to yield surface</span>
                    <span class="n">fy0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_full_yf</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>  <span class="c1"># distance of initial stress state to yield locus</span>
                <span class="n">st_scal</span> <span class="o">+=</span> <span class="n">fy0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_seq</span><span class="p">(</span><span class="n">dsig</span><span class="p">)</span>
                <span class="n">deps_el</span> <span class="o">=</span> <span class="n">deps</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">st_scal</span><span class="p">)</span> <span class="c1"># calculate elastic part of load step</span>
                <span class="n">sig</span> <span class="o">+=</span> <span class="n">CV</span> <span class="o">@</span> <span class="n">deps_el</span>  <span class="c1"># update stress which lies now on yield locus</span>
                <span class="n">grad_stiff</span> <span class="o">=</span> <span class="n">CV</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">st_scal</span><span class="p">)</span>  <span class="c1"># contribution to gradient stiffness </span>
                <span class="n">deps_r</span> <span class="o">=</span> <span class="n">deps</span> <span class="o">-</span> <span class="n">deps_el</span> <span class="c1"># remaining load step</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># load step starts on yield locus</span>
                <span class="n">deps_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span> <span class="c1"># create new variable to prevent deps from being changed</span>
                <span class="n">grad_stiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span> <span class="c1"># initialize stiffness matrix</span>
            
            <span class="c1"># do a first trial step with full deps_r</span>
            <span class="n">ddepl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epl_dot</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">epl</span><span class="p">,</span> <span class="n">CV</span><span class="p">,</span> <span class="n">deps_r</span><span class="p">)</span> <span class="c1"># plastic strain increment</span>
            <span class="n">t_stiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_tan</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">CV</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>  <span class="c1"># tangent stiffness</span>
            <span class="n">peeqt</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">epl</span><span class="o">+</span><span class="n">depl</span><span class="o">+</span><span class="n">ddepl</span><span class="p">)</span>
            <span class="n">dsig</span> <span class="o">=</span> <span class="n">t_stiff</span> <span class="o">@</span> <span class="n">deps_r</span>  <span class="c1"># update stress with current tangent stiffness</span>
            <span class="c1"># evaluate yield function at the end of this step</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span><span class="p">:</span> <span class="c1"># and self.msparam is not None:</span>
                <span class="n">fy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_full_yf</span><span class="p">(</span><span class="n">sig</span><span class="o">+</span><span class="n">dsig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeqt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">sig</span><span class="o">+</span><span class="n">dsig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeqt</span><span class="p">)</span>
            
            <span class="c1"># if remaining step deps_r is too large, better to subdivide it</span>
            <span class="k">if</span> <span class="n">fy1</span> <span class="o">&gt;</span> <span class="n">toler</span><span class="p">:</span>
                <span class="c1">#subdivide load step</span>
                <span class="n">deps_r</span> <span class="o">/=</span> <span class="n">maxit</span>
                <span class="n">nsteps</span> <span class="o">=</span> <span class="n">maxit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nsteps</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="k">for</span> <span class="n">niter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">):</span> 
                <span class="c1"># at this stage, the initial stress sig should lie on the yield locus</span>
                <span class="c1"># and the yield function fy1 points outside</span>
                <span class="c1"># in the following, the remaining load step is performed </span>
                <span class="n">ddepl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epl_dot</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">epl</span><span class="p">,</span> <span class="n">CV</span><span class="p">,</span> <span class="n">deps_r</span><span class="p">)</span> <span class="c1"># plastic strain increment</span>
                <span class="n">t_stiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_tan</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">CV</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>  <span class="c1"># tangent stiffness</span>
                <span class="n">peeq</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">epl</span><span class="o">+</span><span class="n">depl</span><span class="o">+</span><span class="n">ddepl</span><span class="p">)</span>
                <span class="n">dsig</span> <span class="o">=</span> <span class="n">t_stiff</span> <span class="o">@</span> <span class="n">deps_r</span>  <span class="c1"># update stress with current tangent stiffness</span>
                <span class="n">sig</span> <span class="o">+=</span> <span class="n">dsig</span>
                <span class="c1"># evaluate yield function at the end of this step</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span><span class="p">:</span> <span class="c1"># and self.msparam is not None:</span>
                    <span class="n">fy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_full_yf</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">fy1</span> <span class="o">&gt;</span> <span class="n">toler</span><span class="p">:</span>
                    <span class="c1"># the step size was too large because it ends outside of the yield locus</span>
                    <span class="c1"># a correction is needed</span>
                    <span class="c1"># total strain must remain constant during this correction</span>
                    <span class="c1">#calculate compliance tensor</span>
                    <span class="n">SV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="k">if</span> <span class="n">CV</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">1.</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">hh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">CV</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">])</span> <span class="c1"># calculate inverse of sub-tensor</span>
                    <span class="n">SV</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hh</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">CV</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">1.</span><span class="p">:</span> <span class="n">SV</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">CV</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                    
                    <span class="n">dsig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">fy1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_seq</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="c1"># excess stress tensor</span>
                    <span class="n">sig</span> <span class="o">-=</span> <span class="n">dsig</span>   <span class="c1"># reduce stress about excess stress</span>
                    <span class="n">ddepl</span> <span class="o">+=</span> <span class="n">SV</span> <span class="o">@</span> <span class="n">dsig</span> <span class="c1"># add plastic strain to balance the elastic strain, violation of volume conservation!</span>
                    <span class="n">peeq</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">epl</span><span class="o">+</span><span class="n">depl</span><span class="o">+</span><span class="n">ddepl</span><span class="p">)</span>
                    <span class="c1"># calculate tangent stiffness matrix for correction step</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">deps_r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">deps_r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">deps_r</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> \
                        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">deps_r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">deps_r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">deps_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> \
                        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">deps_r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">deps_r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">deps_r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">]])</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dsig</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">Ct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
                    <span class="n">Ct</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span> \
                                   <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> \
                                   <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]]])</span>
                    <span class="n">t_stiff</span> <span class="o">-=</span> <span class="n">Ct</span>
                    <span class="c1">#update yield function</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span><span class="p">:</span> <span class="c1"># and self.msparam is not None:</span>
                        <span class="n">fy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_full_yf</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
                <span class="n">grad_stiff</span> <span class="o">+=</span> <span class="n">t_stiff</span><span class="o">*</span><span class="n">st_scal</span><span class="o">/</span><span class="n">nsteps</span>
                <span class="n">depl</span> <span class="o">+=</span> <span class="n">ddepl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;nsteps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">niter</span>
        <span class="k">return</span> <span class="n">fy1</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">depl</span><span class="p">,</span> <span class="n">grad_stiff</span></div>
    
<div class="viewcode-block" id="Material.calc_yf"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.calc_yf">[docs]</a>    <span class="k">def</span> <span class="nf">calc_yf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ana</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pred</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate yield function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sig  : (sdim,) or (N,sdim) array</span>
<span class="sd">            Stresses (arrays of Voigt or principal stresses)</span>
<span class="sd">        peeq : float or array</span>
<span class="sd">            Equivalent plastic strain (scalar or same length as sig) (optional, default: 0)</span>
<span class="sd">        ana  : Boolean</span>
<span class="sd">            Indicator if analytical solution should be used, rather than ML yield fct (optional, default: False)</span>
<span class="sd">        pred : Boolean</span>
<span class="sd">            Indicator if prediction value should be returned, rather then decision function (optional, default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        f    : flot or 1d-array</span>
<span class="sd">            Yield function for given stress (same length as sig)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ana</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sh</span><span class="o">==</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="ow">or</span> <span class="n">sh</span><span class="o">==</span><span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sig</span><span class="p">])</span>
                <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_eq_j2</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">-</span> <span class="mf">1.</span>
                <span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_polar_ang</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">sig_dev</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sh</span><span class="o">==</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sh</span><span class="o">==</span><span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                    <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span> <span class="o">=</span> <span class="n">peeq</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span> <span class="o">-</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="p">:</span>
                <span class="n">ih</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ind_tx</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">):</span>
                    <span class="n">x</span><span class="p">[:,</span><span class="n">ih</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span>
            <span class="k">if</span> <span class="n">pred</span><span class="p">:</span>
                <span class="c1"># use prediction, returns either -1 or +1</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;yield_fct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ML_yf-predict&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># use continuous decision function in range [-1,+1]</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;yield_fct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ML_yf-decision-fct&#39;</span>
            <span class="k">if</span> <span class="n">N</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_seq</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sflow</span><span class="p">(</span><span class="n">peeq</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;yield_fct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;analytical&#39;</span>
        <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="Material.ML_full_yf"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.ML_full_yf">[docs]</a>    <span class="k">def</span> <span class="nf">ML_full_yf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ld</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate full ML yield function as distance of a single given stress</span>
<span class="sd">        tensor to the yield locus in loading direction.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sig : (sdim,) array</span>
<span class="sd">            Voigt stress tensor</span>
<span class="sd">        peeq : float</span>
<span class="sd">            Equivalent plastic strain (optional, default: 0)</span>
<span class="sd">        ld  : (6,) array</span>
<span class="sd">            Vector of loading direction in princ. stress space (optional)</span>
<span class="sd">        verb : Boolean</span>
<span class="sd">            Indicate whether to be verbose in text output (optional, default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        yf : float</span>
<span class="sd">            Full ML yield function, i.e. distance of sig to yield locus in ld-direction</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">sh</span><span class="o">!=</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="ow">and</span> <span class="n">sh</span><span class="o">!=</span><span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only individual stress tensors supported in material.ML_full_yf. Shape of argument is </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sh</span><span class="p">))</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_seq</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="n">sflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sflow</span><span class="p">(</span><span class="n">peeq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seq</span><span class="o">&lt;</span><span class="mf">0.01</span> <span class="ow">and</span> <span class="n">ld</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># return conservative estimate of yield function for small stresses</span>
            <span class="c1"># and unknown loading direction</span>
            <span class="n">yf</span> <span class="o">=</span> <span class="n">seq</span> <span class="o">-</span> <span class="mf">0.85</span><span class="o">*</span><span class="n">sflow</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ld</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># construct unit stress in loading direction</span>
                <span class="n">su</span> <span class="o">=</span> <span class="n">sig</span><span class="o">/</span><span class="n">seq</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#convert ld to unit stress</span>
                <span class="n">su</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">)</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hh</span><span class="o">&lt;</span><span class="mf">1.e-3</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ML_full_yf called with inconsitent ld=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;calling routine: &#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
                    <span class="n">hh</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">ld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">)</span>
                    <span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="n">su</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span><span class="o">/</span><span class="n">hh</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sig</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">su</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NaN detected (MP_full_yf): sig=</span><span class="si">{}</span><span class="s1">, su=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">su</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SEQ=</span><span class="si">{}</span><span class="s1">, ld=</span><span class="si">{}</span><span class="s1">, peeq=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span><span class="n">ld</span><span class="p">,</span><span class="n">peeq</span><span class="p">))</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">sflow</span>  <span class="c1"># starting value of yield point search</span>
            <span class="k">if</span> <span class="n">su</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">su</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.e-5</span><span class="p">:</span>
                <span class="c1"># correction of starting value for pure shear cases</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tresca</span><span class="p">:</span>
                    <span class="n">x0</span> <span class="o">*=</span> <span class="mf">0.4</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x0</span> <span class="o">*=</span> <span class="mf">0.5</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_yloc_scalar</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">peeq</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">x0</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">:</span>
                <span class="c1">#find x0 with negative yield fct</span>
                <span class="n">x0</span> <span class="o">*=</span> <span class="mf">0.95</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_yloc_scalar</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">peeq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">x1</span><span class="o">&lt;</span><span class="mf">4.</span><span class="o">*</span><span class="n">sflow</span><span class="p">:</span>
                <span class="c1">#find x1 with positive yield fct</span>
                <span class="n">x1</span> <span class="o">*=</span> <span class="mf">1.05</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_yloc_scalar</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">peeq</span><span class="p">)</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_yloc_scalar</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">peeq</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f0</span><span class="o">*</span><span class="n">f1</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ML_full_yf: Could not bracket yield function: &#39;</span>\
                    <span class="o">+</span><span class="s1">&#39;sig=</span><span class="si">{}</span><span class="s1">, x0=</span><span class="si">{}</span><span class="s1">, f0=</span><span class="si">{}</span><span class="s1">, x1=</span><span class="si">{}</span><span class="s1">, f1=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">f0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">f1</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">seq</span> <span class="o">-</span> <span class="mf">0.85</span><span class="o">*</span><span class="n">sflow</span>         
            <span class="c1">#x1, infodict, ier, msg = fsolve(self.find_yloc, x0, args=(su,peeq), xtol=1.e-5, full_output=True)</span>
            <span class="c1">#xs = x1[0]</span>
            <span class="c1">#ys = infodict[&#39;fvec&#39;]</span>
            <span class="c1">#xs, r = bisect(self.find_yloc_scalar, x0, x1, args=(su,peeq), xtol=1.e-5, full_output=True)</span>
            <span class="c1">#ys = self.find_yloc(xs, su, peeq)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">root_scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find_yloc_scalar</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_method</span><span class="p">,</span> <span class="n">bracket</span><span class="o">=</span><span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">],</span> 
                            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">su</span><span class="p">,</span><span class="n">peeq</span><span class="p">),</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">)</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">root</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">converged</span> <span class="ow">and</span> <span class="n">xs</span><span class="o">&lt;</span><span class="mf">4.</span><span class="o">*</span><span class="n">sflow</span><span class="p">:</span>
                <span class="c1"># zero of ML yield fct. detected at x1*su</span>
                <span class="n">yf</span> <span class="o">=</span> <span class="n">seq</span> <span class="o">-</span> <span class="n">xs</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_seq</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># zero of ML yield fct. not found: get conservative estimate</span>
                <span class="n">yf</span> <span class="o">=</span> <span class="n">seq</span> <span class="o">-</span> <span class="mf">0.85</span><span class="o">*</span><span class="n">sflow</span>
                <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
                    <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_yloc_scalar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">peeq</span><span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ML_full_yf&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** detection not successful. yf=</span><span class="si">{}</span><span class="s1">, seq=</span><span class="si">{}</span><span class="s1">, ld=</span><span class="si">{}</span><span class="s1">, su:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yf</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span><span class="n">ld</span><span class="p">,</span> <span class="n">su</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** optimization result (x1=</span><span class="si">{}</span><span class="s1">,y1=</span><span class="si">{}</span><span class="s1">,msg=</span><span class="si">{}</span><span class="s1">):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">yf</span></div>

<div class="viewcode-block" id="Material.find_yloc"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.find_yloc">[docs]</a>    <span class="k">def</span> <span class="nf">find_yloc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function to expand unit stresses by factor and calculate yield function;</span>
<span class="sd">        used by search algorithm to find zeros of yield function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : (N,)-array</span>
<span class="sd">            Multiplyer for stress</span>
<span class="sd">        su : (N,sdim) array</span>
<span class="sd">            Unit stress</span>
<span class="sd">        peeq : float</span>
<span class="sd">            Equivalent plastic strain (optional, default: 0)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        f : (N,)-array</span>
<span class="sd">            Yield function evaluated at sig=x.sp</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">su</span><span class="p">,</span><span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span></div>
    
<div class="viewcode-block" id="Material.find_yloc_scalar"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.find_yloc_scalar">[docs]</a>    <span class="k">def</span> <span class="nf">find_yloc_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function to expand unit stresses by factor and calculate yield function;</span>
<span class="sd">        used by search algorithm to find zeros of yield function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x  : float</span>
<span class="sd">            Multiplyer for stress</span>
<span class="sd">        su : (sdim,) array</span>
<span class="sd">            Unit stress</span>
<span class="sd">        peeq : float</span>
<span class="sd">            Equivalent plastic strain (optional, default: 0)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        f : float</span>
<span class="sd">            Yield function evaluated at sig=x.sp</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">su</span><span class="p">,</span><span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span></div>
    
<div class="viewcode-block" id="Material.calc_seq"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.calc_seq">[docs]</a>    <span class="k">def</span> <span class="nf">calc_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate generalized equivalent stress from stress tensor;</span>
<span class="sd">        equivalent J2 stress for isotropic flow behavior and tension compression invariance;</span>
<span class="sd">        Hill-type approach for anisotropic plastic yielding;</span>
<span class="sd">        Drucker-like approach for tension-compression asymmetry;</span>
<span class="sd">        Barlat 2004-18p model for plastic anisotropy;</span>
<span class="sd">        Tresca equivalent stress</span>
<span class="sd">        </span>
<span class="sd">        Step 1: transform input into </span>
<span class="sd">          (i)   sig: (N,6)-array of Voigt stresses (zeros added if input is princ. stresses)  </span>
<span class="sd">          (ii)  sp: (N,3)-array of principal stresses  </span>
<span class="sd">          </span>
<span class="sd">          N=1 if input is single stress in which case return value is of type float</span>
<span class="sd">        </span>
<span class="sd">        Step 2: Call appropriate subroutines for evaluation of equiv. stress. Currently supported are: </span>
<span class="sd">          (i)   Tresca</span>
<span class="sd">          (ii)  Barlat Yld2004-18p</span>
<span class="sd">          (iii) Hill 3-parameter (hill_3p) or 6-parameter (hill_6p)</span>
<span class="sd">          (iv) von Mises/J2 (special case of Hill with all coefficients equal 1, </span>
<span class="sd">                             material independent, works also for elastic and ML materials)  </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sig : (sdim,) or (N,sdim) array</span>
<span class="sd">            Stress values (for dim=3 principal stresses are assumed, otherwise Voigt stress)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        seq : float or (N,) array</span>
<span class="sd">            Hill-Drucker-type equivalent stress</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="c1">#Step 1: Transform input</span>
        <span class="k">if</span> <span class="n">sh</span><span class="o">==</span><span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
            <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># sp is single principal stress vector</span>
            <span class="n">sp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sig</span><span class="p">])</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">sh</span><span class="o">==</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">sp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sh</span><span class="o">==</span><span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
            <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">sig_princ</span><span class="p">(</span><span class="n">sig</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sp</span><span class="p">])</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sig</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">sh</span><span class="o">==</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">sig_princ</span><span class="p">(</span><span class="n">sig</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** calc_seq: N=</span><span class="si">{}</span><span class="s1">, sh=</span><span class="si">{}</span><span class="s1">, caller=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unknown format of stress in calc_seq&#39;</span><span class="p">)</span>
            
        <span class="c1">#Step 2: call subroutines or evaluate von Mises/J2 equiv stress</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tresca</span><span class="p">:</span>
            <span class="c1">#calculate Tresca equiv. stress</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">barlat</span><span class="p">:</span>
            <span class="c1">#calculate Baralat equiv. stress</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_seqB</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate J2 or Hill equiv. stress</span>
            <span class="n">I1</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span> <span class="c1"># hydrostatic stress as 1st invariant</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
                <span class="c1"># elastic material</span>
                <span class="n">hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">d0</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hill</span>
                <span class="n">d0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drucker</span>

            <span class="c1"># consider anisotropy in flow behavior in second invariant in Hill-type approach</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hill_6p</span><span class="p">:</span>
                <span class="c1"># equiv. stress for full 6-parameter Hill model</span>
                <span class="n">I2</span> <span class="o">=</span> <span class="n">hp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                     <span class="n">hp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> \
                     <span class="n">hp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                     <span class="mf">6.</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">3</span><span class="p">])</span>       <span class="o">+</span> \
                     <span class="mf">6.</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">4</span><span class="p">])</span>       <span class="o">+</span> \
                     <span class="mf">6.</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">I2</span> <span class="o">*=</span> <span class="mf">0.5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;equiv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;6-parameter Hill, full Voigt stress&#39;</span>
                <span class="c1">#print(&#39;Full stress&#39;, np.sqrt(I2))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># standard: equiv. stress based on princ. stresses with 3-parameter Hill model</span>
                <span class="c1"># calculate Hill or J2 equiv. stress (latter is default, all Hill parameters = 1)</span>
                <span class="n">d12</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">d23</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">d31</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">sp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">I2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">hp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">d12</span><span class="p">)</span> <span class="o">+</span> <span class="n">hp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">d23</span><span class="p">)</span> <span class="o">+</span> <span class="n">hp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">d31</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;equiv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3-parameter Hill&#39;</span>
            <span class="c1"># eqiv stress including hydrostatic stress for tension-compression assymetry</span>
            <span class="n">seq</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">I2</span><span class="p">)</span> <span class="o">+</span> <span class="n">d0</span><span class="o">*</span><span class="n">I1</span>   <span class="c1"># generalized eqiv. stress</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">seq</span></div>
    
<div class="viewcode-block" id="Material.calc_seqB"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.calc_seqB">[docs]</a>    <span class="k">def</span> <span class="nf">calc_seqB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sv</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate equivalent stress based on Yld2004-18p yield function </span>
<span class="sd">        proposed by Barlat et al, Int. J. Plast. 21 (2005) 1009</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sv : (6,) array</span>
<span class="sd">            Voigt stress tensor</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        seq : float</span>
<span class="sd">            Equivalent stress</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">sig_dev</span><span class="p">(</span><span class="n">sv</span><span class="p">)</span>
        <span class="n">st1</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bar_m1</span> <span class="o">@</span> <span class="n">sd</span>  <span class="c1"># first linearly transformed stress deviator s_tilda_&#39;</span>
        <span class="n">st2</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bar_m2</span> <span class="o">@</span> <span class="n">sd</span>  <span class="c1"># second linearly transformed stress deviator s_tilda_&#39;&#39;</span>
        <span class="n">Stp1</span> <span class="o">=</span> <span class="n">sig_princ</span><span class="p">(</span><span class="n">st1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># principal stress of transformed stress</span>
        <span class="n">Stp2</span> <span class="o">=</span> <span class="n">sig_princ</span><span class="p">(</span><span class="n">st2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barlat_exp</span>
        <span class="n">seq</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Stp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Stp2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="n">a</span>  <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Stp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Stp2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="n">a</span>  <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Stp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Stp2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="n">a</span> <span class="o">+</span> \
               <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Stp1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Stp2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="n">a</span>  <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Stp1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Stp2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="n">a</span>  <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Stp1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Stp2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="n">a</span> <span class="o">+</span> \
               <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Stp1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Stp2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="n">a</span>  <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Stp1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Stp2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="n">a</span>  <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Stp1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Stp2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="n">a</span>  
        <span class="n">seq</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">0.25</span><span class="o">*</span><span class="n">seq</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seq</span></div>
    
<div class="viewcode-block" id="Material.calc_fgrad"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.calc_fgrad">[docs]</a>    <span class="k">def</span> <span class="nf">calc_fgrad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ana</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate gradient to yield surface. Three different methods can be used: (i) analytical gradient to Hill-like yield</span>
<span class="sd">        function (default if no ML yield function exists - ML_yf=False), (ii) gradient to ML yield function (default if ML yield</span>
<span class="sd">        function exists - ML_yf=True; can be overwritten if ana=True), (iii) ML gradient fitted seperately from ML yield function</span>
<span class="sd">        (activated if ML_grad=True and ana=False)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sig : (sdim,) or (N,sdim) array</span>
<span class="sd">            Stress value (Pricipal stress or full stress tensor)</span>
<span class="sd">        seq : float or (N,) array</span>
<span class="sd">            Equivalent stresses (optional)</span>
<span class="sd">        ana : Boolean</span>
<span class="sd">            Indicator if analytical solution should be used, rather than ML yield fct (optional, default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fgrad : (sdim,), (N,sdim) array</span>
<span class="sd">            Gradient to yield surface at given position in stress space, same dimension as sdim</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sh</span><span class="o">==</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="ow">or</span> <span class="n">sh</span><span class="o">==</span><span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
            <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># sig is vector of principal stresses</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sig</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">sh</span><span class="o">!=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown format of stress in calc_fgrad&#39;</span><span class="p">)</span>
        <span class="n">fgrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_grad</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ana</span><span class="p">:</span>
            <span class="c1">#use SVR fitted to gradient</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
            <span class="n">fgrad</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_grad0</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gscale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fgrad</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_grad1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gscale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fgrad</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_grad2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gscale</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SVR gradient&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ana</span><span class="p">:</span>
            <span class="c1">#use gradient of SVC yield fct. in stress space</span>
            <span class="c1">#gradient of SVC kernel function w.r.t. feature vector</span>
            <span class="k">def</span> <span class="nf">grad_rbf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">xp</span><span class="p">):</span>
                <span class="c1"># x.shape=(5,)</span>
                <span class="c1"># xp.shape=(Nsv,5)</span>
                <span class="c1"># grad.shape=(Nsv,5)</span>
                <span class="n">hv</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">xp</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hv</span><span class="o">*</span><span class="n">hv</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># ||x-x&#39;||^2=sum_i(x_i-x&#39;_i)^2</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">gam_yf</span><span class="o">*</span><span class="n">hh</span><span class="p">)</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gam_yf</span><span class="o">*</span><span class="n">hv</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">k</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">arg</span>
                <span class="c1">#arg = -2.*self.gam_yf*np.sqrt(hh)/np.linalg.norm(hv,axis=1)</span>
                <span class="c1">#grad = (k*arg)[:,None]*hv</span>
                <span class="k">return</span> <span class="n">grad</span>            <span class="c1">#define Jacobian of coordinate transformation</span>
            <span class="k">def</span> <span class="nf">Jac</span><span class="p">(</span><span class="n">sig</span><span class="p">):</span>
                <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">dev</span> <span class="o">=</span> <span class="n">sig_dev</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>  <span class="c1"># deviatoric princ. stress</span>
                <span class="n">vn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>  <span class="c1">#norm of stress vector</span>
                <span class="k">if</span> <span class="n">vn</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">:</span>
                    <span class="c1"># calculate Jacobian only if sig&gt;0</span>
                    <span class="n">dseqds</span> <span class="o">=</span> <span class="mf">3.</span><span class="o">*</span><span class="n">dev</span><span class="o">/</span><span class="n">vn</span>
                    <span class="n">J</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">3.</span>
                    <span class="n">J</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dseqds</span>
                    <span class="n">dsa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">a_vec</span><span class="p">)</span>
                    <span class="n">dsb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">b_vec</span><span class="p">)</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="n">dsa</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">dsb</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">((</span><span class="n">a_vec</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">b_vec</span><span class="p">)</span><span class="o">/</span><span class="n">sc</span> <span class="o">-</span> <span class="n">dseqds</span><span class="o">/</span><span class="n">vn</span><span class="p">)</span>
                    <span class="n">J</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">J</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_eq_j2</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">-</span> <span class="mf">1.</span>
                <span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_polar_ang</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_dev</span><span class="p">(</span><span class="n">sig</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span> <span class="o">=</span> <span class="n">peeq</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span> <span class="o">-</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="p">:</span>
                <span class="n">ih</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ind_tx</span>
                <span class="n">x</span><span class="p">[:,</span><span class="n">ih</span><span class="p">:</span><span class="n">ih</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">)]</span>
            <span class="n">dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">dual_coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">sv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">support_vectors_</span>
            <span class="n">hk</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="n">grad_rbf</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">sv</span><span class="p">)</span>
                <span class="n">dKdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dc</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">hh</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="p">:</span>
                    <span class="n">hk</span> <span class="o">-=</span> <span class="n">dKdx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                    <span class="n">fgrad</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Jac</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="n">dKdx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fgrad</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">dKdx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">khard</span> <span class="o">=</span> <span class="n">hk</span><span class="o">/</span><span class="n">N</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gradient to ML_yf&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># calculate analytical gradient based on the active material formulation </span>
            <span class="c1"># standard: Hill definition of equiv. stress, which contains isotropic J2 equiv. stress</span>
            <span class="c1"># as special case.</span>
            <span class="c1"># currently implemented: J2, 3-parameter Hill (only principal stresses), 6-parameter Hill full stress tensor</span>
            <span class="c1"># no gradient yet for Barlat and Tresca, numerical gradient</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">barlat</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;calc_fgrad: analytical gradient for Barlat not implemented&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tresca</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;calc_fgrad: analytical gradient for Tresca not implemented&#39;</span><span class="p">)</span>
            <span class="n">h0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hill</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">h1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hill</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hill</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">d3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drucker</span><span class="o">/</span><span class="mf">3.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_seq</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">sig_dev</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
            <span class="n">fgrad</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">h0</span><span class="o">+</span><span class="n">h2</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h0</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">h2</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="n">d3</span>
            <span class="n">fgrad</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">h1</span><span class="o">+</span><span class="n">h0</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">h0</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h1</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="n">d3</span>
            <span class="n">fgrad</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">h2</span><span class="o">+</span><span class="n">h1</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">h2</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h1</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="n">d3</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
                <span class="n">h3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hill</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">h4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hill</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">h5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hill</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">fgrad</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.</span><span class="o">*</span><span class="n">h3</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">seq</span>
                <span class="n">fgrad</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.</span><span class="o">*</span><span class="n">h4</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="n">seq</span>
                <span class="n">fgrad</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.</span><span class="o">*</span><span class="n">h5</span><span class="o">*</span><span class="n">sig</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="n">seq</span>
                <span class="k">if</span> <span class="n">h0</span><span class="o">==</span><span class="n">h1</span><span class="o">==</span><span class="n">h2</span><span class="o">==</span><span class="n">h3</span><span class="o">==</span><span class="n">h4</span><span class="o">==</span><span class="n">h5</span><span class="o">==</span><span class="mf">1.</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;analytical, J2 isotropic, full stress&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;analytical, 6-parameter Hill, full stress&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">h0</span><span class="o">==</span><span class="n">h1</span><span class="o">==</span><span class="n">h2</span><span class="o">==</span><span class="mf">1.</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;analytical, J2 isotropic, princ. stress&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;analytical, 3-parameter Hill, princ. stress&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">fgrad</span> <span class="o">=</span> <span class="n">fgrad</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
        <span class="k">return</span> <span class="n">fgrad</span></div>
    
<div class="viewcode-block" id="Material.get_sflow"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.get_sflow">[docs]</a>    <span class="k">def</span> <span class="nf">get_sflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peeq</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate average flow stress of current texture for given equiv plastic strain.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        peeq : float</span>
<span class="sd">            Current value of equiv. plastic strain</span>
<span class="sd">            </span>
<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        sflow : float</span>
<span class="sd">            Average flow stress&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy</span> <span class="o">+</span> <span class="n">peeq</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">khard</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sm</span><span class="o">&lt;</span><span class="mf">1.e-3</span><span class="p">:</span>
                <span class="n">wght</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wght</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="o">/</span><span class="n">sm</span>
            <span class="n">sflow</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ms</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">):</span>
                <span class="n">sflow</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">peeq</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">epc</span><span class="p">,</span> <span class="n">ms</span><span class="p">[</span><span class="s1">&#39;work_hard&#39;</span><span class="p">],</span> <span class="n">ms</span><span class="p">[</span><span class="s1">&#39;flow_seq_av&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ms_index</span><span class="p">[</span><span class="n">i</span><span class="p">],:])</span><span class="o">*</span><span class="n">wght</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sflow</span></div>

<div class="viewcode-block" id="Material.epl_dot"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.epl_dot">[docs]</a>    <span class="k">def</span> <span class="nf">epl_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">epl</span><span class="p">,</span> <span class="n">Cel</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate plastic strain increment relaxing stress back to yield locus;</span>
<span class="sd">        Reference: M.A. Crisfield, Non-linear finite element analysis of solids and structures,</span>
<span class="sd">        Chapter 6, Eqs. (6.4), (6.8) and (6.17)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sig : (6,)-array</span>
<span class="sd">            Voigt stress tensor</span>
<span class="sd">        epl : (6,)-array</span>
<span class="sd">            Voigt plastic strain tensor</span>
<span class="sd">        Cel : (6,6) array</span>
<span class="sd">            Elastic stiffnes tensor</span>
<span class="sd">        deps: Voigt tensor</span>
<span class="sd">            Strain increment from predictor step</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pdot : Voigt tensor</span>
<span class="sd">            Plastic strain increment</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">peeq</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">epl</span><span class="p">)</span>     <span class="c1"># equiv. plastic strain</span>
        <span class="n">yfun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">sig</span><span class="o">+</span><span class="n">Cel</span><span class="nd">@deps</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
        <span class="c1">#for DEBUGGING</span>
        <span class="sd">&#39;&#39;&#39;yf0  = self.calc_yf(sig, peeq=peeq)</span>
<span class="sd">        if yf0&lt;-ptol and yfun&gt;ptol and peeq&lt;1.e-5:</span>
<span class="sd">            if self.ML_yf:</span>
<span class="sd">                ds = Cel@deps</span>
<span class="sd">                yfun = self.ML_full_yf(sig+ds)</span>
<span class="sd">            print(&#39;*** Warning in epl_dot: Step crosses yield surface&#39;)</span>
<span class="sd">            print(&#39;sig, epl, deps, yfun, yf0, peeq,caller&#39;, sig, epl, deps, yfun, yf0, peeq, sys._getframe().f_back.f_code.co_name)</span>
<span class="sd">            yfun=0. # catch error that can be produced for anisotropic materials&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yfun</span><span class="o">&lt;=</span><span class="n">ptol</span><span class="p">):</span>
            <span class="n">pdot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="c1">#print(&#39;WARNING: Test for small stresses will be depracted in next version&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_fgrad</span><span class="p">(</span><span class="n">sig_princ</span><span class="p">(</span><span class="n">sig</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_fgrad</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
            <span class="n">hh</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Cel</span> <span class="o">@</span> <span class="n">a</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">khard</span>
            <span class="n">lam_dot</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Cel</span> <span class="o">@</span> <span class="n">deps</span> <span class="o">/</span> <span class="n">hh</span>  <span class="c1"># deps must not contain elastic strain components</span>
            <span class="n">pdot</span> <span class="o">=</span> <span class="n">lam_dot</span> <span class="o">*</span> <span class="n">a</span>
        <span class="k">return</span> <span class="n">pdot</span></div>

<div class="viewcode-block" id="Material.C_tan"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.C_tan">[docs]</a>    <span class="k">def</span> <span class="nf">C_tan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">Cel</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate tangent stiffness relaxing stress back to yield locus;</span>
<span class="sd">        Reference: M.A. Crisfield, Non-linear finite element analysis of solids and structures,</span>
<span class="sd">        Chapter 6, Eqs. (6.9) and (6.18)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sig : Voigt tensor</span>
<span class="sd">            Stress</span>
<span class="sd">        Cel : (6,6) array</span>
<span class="sd">            Elastic stiffness tensor used for predictor step</span>
<span class="sd">        peeq : float</span>
<span class="sd">            Equivalent plastic strain (optional, default: 0.)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Ct : (6,6) array</span>
<span class="sd">            Tangent stiffness tensor</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_fgrad</span><span class="p">(</span><span class="n">sig_princ</span><span class="p">(</span><span class="n">sig</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_fgrad</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">)</span>
        <span class="n">hh</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Cel</span> <span class="o">@</span> <span class="n">a</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">khard</span>
        <span class="n">ca</span> <span class="o">=</span> <span class="n">Cel</span> <span class="o">@</span> <span class="n">a</span>
        <span class="n">Ct</span> <span class="o">=</span> <span class="n">Cel</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">ca</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="n">hh</span>
        <span class="k">return</span> <span class="n">Ct</span></div>
    
    <span class="c1">#==============================================================</span>
    <span class="c1"># subroutines for ML flow rule, training</span>
    <span class="c1">#==============================================================</span>

<div class="viewcode-block" id="Material.setup_yf_SVM_6D"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.setup_yf_SVM_6D">[docs]</a>    <span class="k">def</span> <span class="nf">setup_yf_SVM_6D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gridsearch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initialize and train Support Vector Classifier (SVC) as machine learning (ML) yield function. Training and test</span>
<span class="sd">        data (features) are accepted as either 3D principal stresses or cylindrical stresses, but principal stresses will</span>
<span class="sd">        be converted to cylindrical stresses, such that training is always performed in cylindrical stress space, with equiv. </span>
<span class="sd">        stress at yield onset and polar angle as degrees of freedom. Graphical output on the trained SVC yield function is </span>
<span class="sd">        possible.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x   :  (N,self.Ndof) array</span>
<span class="sd">            Training data in form of deviatoric Voigt stresses, components s1-s6), s0=-s1-s2.</span>
<span class="sd">            Additional DOF for work hardening and texture if considered.</span>
<span class="sd">        y_train : 1d-array</span>
<span class="sd">            Result vector for training data (same size as x)</span>
<span class="sd">        x_test  : (N,self.Ndof) array</span>
<span class="sd">            Test data either as Cartesian princ. stresses (N,3) or cylindrical stresses (N,2) (optional)</span>
<span class="sd">        y_test</span>
<span class="sd">            Result vector for test data (optional)</span>
<span class="sd">        C  : float</span>
<span class="sd">            Parameter for training of SVC (optional, default: 10)</span>
<span class="sd">        gamma  : float</span>
<span class="sd">            Parameter for kernel function of SVC (optional, default: 1)</span>
<span class="sd">        plot : Boolean</span>
<span class="sd">            Indicates if plot of decision function should be generated (optional, default: False)</span>
<span class="sd">        gridsearch : Boolean</span>
<span class="sd">            Perform grid search to optimize hyperparameters of ML flow rule (optional, default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        train_sc : float</span>
<span class="sd">            Training score</span>
<span class="sd">        test_sc  : float</span>
<span class="sd">            test score</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># calculate proper scaling factor and scale data in input vector into range [-1,+1] for all columns</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">{}</span><span class="s1"> full Voigt yield stresses for training.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span> <span class="o">==</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gam_yf</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_yf</span> <span class="o">=</span> <span class="n">C</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#calculate scaling factors need for SVC training from microstructure parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span>  <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;flow_seq_av&#39;</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span>  <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;work_hard&#39;</span><span class="p">])</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">epc</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;texture&#39;</span><span class="p">])</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="p">))</span>
        <span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="p">:</span>
            <span class="n">X_train</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span> <span class="o">-</span> <span class="mf">1.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using work hardening data &quot;</span><span class="si">%s</span><span class="s1">&quot; for training: </span><span class="si">%i</span><span class="s1"> data sets up to PEEQ=</span><span class="si">%6.3f</span><span class="s1">&#39;</span> 
                  <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ms_type&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Npl&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;peeq_max&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="p">:</span>
            <span class="n">ih</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ind_tx</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">):</span>
                <span class="n">X_train</span><span class="p">[:,</span><span class="n">ih</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="n">ih</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using texture data &quot;</span><span class="si">%s</span><span class="s1">&quot; for training: </span><span class="si">%i</span><span class="s1"> data sets with texture_parameters in range [</span><span class="si">%4.2f</span><span class="s1">,</span><span class="si">%4.2f</span><span class="s1">]&#39;</span> 
                      <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ms_type&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;Ntext&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;texture&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> \
                         <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;texture&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1">#coordinate transformation for test data</span>
        <span class="k">if</span> <span class="n">x_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Ntest</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ntest</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="p">))</span>
            <span class="n">X_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="p">:</span>
                <span class="n">X_test</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span> <span class="o">-</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="p">:</span>
                <span class="n">ih</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ind_tx</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">):</span>
                    <span class="n">X_test</span><span class="p">[:,</span><span class="n">ih</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:,</span><span class="n">ih</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.</span>
        <span class="c1">#define and fit SVC</span>
        <span class="c1"># self.svm_yf = svm.SVC(kernel=&#39;rbf&#39;,C=C,gamma=gamma)</span>
        <span class="c1"># self.svm_yf.fit(X_train, y_train)</span>
        <span class="c1"># self.ML_yf = True</span>

        <span class="k">if</span> <span class="n">gridsearch</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The hyperparameter optimization with Gridsearch to find best C and gamma...&#39;</span><span class="p">)</span>
            <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(),</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The best hyperparameters are:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gam_yf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C_yf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span> <span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">C_yf</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gam_yf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Original values: C=</span><span class="si">{}</span><span class="s1">, gamma=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">gamma</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">#calculate scores</span>
        <span class="n">train_sc</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_sc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_sc</span>  <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        <span class="c1">#create plot if requested</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Plot of extended training data for SVM classification in 2D cylindrical stress space&#39;</span><span class="p">)</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>  <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2500</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2500</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2500</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span><span class="p">]</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Paired</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;extended SVM yield function in training&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\theta/\pi$&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma_</span><span class="si">{eq}</span><span class="s1">/\sigma_y$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">train_sc</span><span class="p">,</span> <span class="n">test_sc</span></div>

<div class="viewcode-block" id="Material.setup_yf_SVM_3D"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.setup_yf_SVM_3D">[docs]</a>    <span class="k">def</span> <span class="nf">setup_yf_SVM_3D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                     <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cyl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gridsearch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cvals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gvals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initialize and train Support Vector Classifier (SVC) as machine learning (ML) yield function. Training and test</span>
<span class="sd">        data (features) are accepted as either 3D principal stresses or cylindrical stresses, but principal stresses will</span>
<span class="sd">        be converted to cylindrical stresses, such that training is always performed in cylindrical stress space, with equiv. </span>
<span class="sd">        stress at yield onset and polar angle as degrees of freedom. Graphical output on the trained SVC yield function is </span>
<span class="sd">        possible.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x   :  (N,2) or (N,3) array</span>
<span class="sd">            Training data either as Cartesian princ. stresses (N,3) or cylindrical stresses (N,2)</span>
<span class="sd">        cyl : Boolean</span>
<span class="sd">            Indicator for cylindrical stresses if x is has shape (N,3)</span>
<span class="sd">        y_train : 1d-array</span>
<span class="sd">            Result vector for training data (same size as x)</span>
<span class="sd">        x_test  : (N,2) or (N,3) array</span>
<span class="sd">            Test data either as Cartesian princ. stresses (N,3) or cylindrical stresses (N,2) (optional)</span>
<span class="sd">        y_test</span>
<span class="sd">            Result vector for test data (optional)</span>
<span class="sd">        C  : float</span>
<span class="sd">            Parameter for training of SVC (optional, default: 10)</span>
<span class="sd">        gamma  : float</span>
<span class="sd">            Parameter for kernel function of SVC (optional, default: 1)</span>
<span class="sd">        fs  : float</span>
<span class="sd">            Parameters for size of periodic continuation of training data (optional, default:0.1)</span>
<span class="sd">        plot : Boolean</span>
<span class="sd">            Indicates if plot of decision function should be generated (optional, default: False)</span>
<span class="sd">        gridsearch : Boolean</span>
<span class="sd">            Perform grid search to optimize hyperparameters of ML flow rule (optional, default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        train_sc : float</span>
<span class="sd">            Training score</span>
<span class="sd">        test_sc  : float</span>
<span class="sd">            test score</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#transformation of princ. stress into cyl. coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gam_yf</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_yf</span> <span class="o">=</span> <span class="n">C</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#calculate scaling factors need for SVC training from microstructure parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span>  <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;flow_seq_av&#39;</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span>  <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;work_hard&#39;</span><span class="p">])</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">epc</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;texture&#39;</span><span class="p">])</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1">#sh = np.shape(x)</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cyl</span><span class="p">:</span>
            <span class="c1">#princ. stresses</span>
            <span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_eq_j2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">-</span> <span class="mf">1.</span>
            <span class="n">X_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_polar_ang</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting principal stresses to cylindrical stresses for training&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#cylindrical stresses</span>
            <span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">-</span> <span class="mf">1.</span>
            <span class="n">X_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using cylindrical stresses for training&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="p">:</span>
            <span class="n">X_train</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span> <span class="o">-</span> <span class="mf">1.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using work hardening data &quot;</span><span class="si">%s</span><span class="s1">&quot; for training: </span><span class="si">%i</span><span class="s1"> data sets up to PEEQ=</span><span class="si">%6.3f</span><span class="s1">&#39;</span> 
                  <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ms_type&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Npl&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;peeq_max&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="p">:</span>
            <span class="n">ih</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ind_tx</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">):</span>
                <span class="n">X_train</span><span class="p">[:,</span><span class="n">ih</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="n">ih</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using texture data &quot;</span><span class="si">%s</span><span class="s1">&quot; for training: </span><span class="si">%i</span><span class="s1"> data sets with texture_parameters in range [</span><span class="si">%4.2f</span><span class="s1">,</span><span class="si">%4.2f</span><span class="s1">]&#39;</span> 
                      <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ms_type&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;Ntext&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;texture&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> \
                         <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;texture&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1">#copy left and right borders to enforce periodicity in theta</span>
        <span class="n">indr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">1.</span><span class="o">-</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">indl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">fs</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">Xr</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">indr</span><span class="p">]</span>
        <span class="n">Xl</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">indl</span><span class="p">]</span>
        <span class="n">Xr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">2.</span>  <span class="c1"># shift angle theta</span>
        <span class="n">Xl</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.</span>
        <span class="n">Xh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xr</span><span class="p">,</span> <span class="n">Xl</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">yh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">indr</span><span class="p">],</span> <span class="n">y_train</span><span class="p">[</span><span class="n">indl</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Xh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">yh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#coordinate transformation for test data</span>
        <span class="k">if</span> <span class="n">x_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Ntest</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ntest</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cyl</span><span class="p">:</span>
                <span class="n">X_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_eq_j2</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">-</span> <span class="mf">1.</span>
                <span class="n">X_test</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_polar_ang</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span> <span class="o">-</span> <span class="mf">1.</span>
                <span class="n">X_test</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="p">:</span>
                <span class="n">X_test</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span> <span class="o">-</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="p">:</span>
                <span class="n">ih</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ind_tx</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">):</span>
                    <span class="n">X_test</span><span class="p">[:,</span><span class="n">ih</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[:,</span><span class="n">ih</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.</span>
        <span class="c1">#define and fit SVC</span>
        <span class="k">if</span> <span class="n">gridsearch</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The hyperparameter optimization with Gridsearch to find best C and gamma...&#39;</span><span class="p">)</span>
            <span class="c1"># define search grid and add user parameters if not present in grid</span>
            <span class="k">if</span> <span class="n">cvals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">cvals</span><span class="p">:</span>
                    <span class="n">cvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gvals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gvals</span> <span class="o">=</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">gvals</span><span class="p">:</span>
                    <span class="n">gvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
            <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">cvals</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">gvals</span><span class="p">}</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(),</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The best hyperparameters are:&#39;</span><span class="p">,</span><span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gam_yf</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C_yf</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">C_yf</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gam_yf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Original values: C=</span><span class="si">{}</span><span class="s1">, gamma=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">gamma</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#calculate scores</span>
        <span class="n">train_sc</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_sc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_sc</span>  <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        <span class="c1">#create plot if requested</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Plot of extended training data for SVM classification in 2D cylindrical stress space&#39;</span><span class="p">)</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">-</span><span class="n">fs</span><span class="p">,</span> <span class="mf">1.</span><span class="o">+</span><span class="n">fs</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>  <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2500</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2500</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2500</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span><span class="p">]</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Paired</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;extended SVM yield function in training&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\theta/\pi$&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma_</span><span class="si">{eq}</span><span class="s1">/\sigma_y$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">train_sc</span><span class="p">,</span> <span class="n">test_sc</span></div>
 
<div class="viewcode-block" id="Material.train_SVC"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.train_SVC">[docs]</a>    <span class="k">def</span> <span class="nf">train_SVC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">Nlc</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">Nseq</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                  <span class="n">mat_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">gridsearch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cvals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gvals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Train SVC for all yield functions of the microstructures provided in msparam and for flow stresses to capture </span>
<span class="sd">        work hardening. In first step, the </span>
<span class="sd">        training data for each set is generated by creating stresses on the deviatoric plane and calculating their catgegorial</span>
<span class="sd">        yield function (&quot;-1&quot;: elastic, &quot;+1&quot;: plastic). Furthermore, axes in different dimensions for microstructural</span>
<span class="sd">        features are introduced that describe the relation between the different sets.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        C     : float</span>
<span class="sd">            Parameter needed for training process, larger values lead to more flexibility (optional, default: 10)</span>
<span class="sd">        gamma : float</span>
<span class="sd">            Parameter of Radial Basis Function of SVC kernel, larger values, lead to faster decay of influence of individual </span>
<span class="sd">            support vectors, i.e., to more short ranged kernels (optional, default: 4)</span>
<span class="sd">        Nlc   : int </span>
<span class="sd">            Number of load cases to be considered, will be overwritten if material has microstructure </span>
<span class="sd">            information (optional, default: 36)</span>
<span class="sd">        Nseq  : int</span>
<span class="sd">            Number of training and test stresses to be generated in elastic regime, same number will be </span>
<span class="sd">            produced in plastic regime (optional, default: 25)</span>
<span class="sd">        fs : float</span>
<span class="sd">            Parameter to ensure peridicity of yield function wrt. theta</span>
<span class="sd">        extend : Boolean</span>
<span class="sd">            Indicate whether training data should be extended further into plastic regime (optional, default: True)</span>
<span class="sd">        mat_ref : object of class ``Material``</span>
<span class="sd">            reference material needed to calculate yield function if only N is provided (optional, ignored if sdata is given)</span>
<span class="sd">        sdata: (N,3) or (N,6) array</span>
<span class="sd">            List of cylindrical stresses (N,3) or Voigt stresses (N,6) lying on yield locus. </span>
<span class="sd">            Based on these yield stresses, training data in entire deviatoric stress space is created</span>
<span class="sd">            (optional, f no data in self.msparam is given, either sdata or N and mat_ref must be provided)</span>
<span class="sd">        plot  : Boolean</span>
<span class="sd">            Indicate if graphical output should be performed (optional, default: False)</span>
<span class="sd">        fontsize : int</span>
<span class="sd">            Fontsize for graph annotations (optional, default: 16)</span>
<span class="sd">        gridsearch : Boolean</span>
<span class="sd">            Perform grid search to optimize hyperparameters of ML flow rule (optional, default: False)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">---------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SVM classification training&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#augment raw data and create result vector (yield function) for all data on work hardening and textures</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Npl</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">Ntext</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">sdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># create regular pattern of stresses in sdim-dimensional stress space</span>
                <span class="c1"># based on reference material</span>
                <span class="k">if</span> <span class="n">mat_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;create_data_sig: Neither sdata nor mat_ref are provided, cannot generate training data&#39;</span><span class="p">)</span>
                <span class="c1"># define material parameters otherwise defines in material.plasticity</span>
                <span class="k">if</span> <span class="n">mat_ref</span><span class="o">.</span><span class="n">CV</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">elasticity</span><span class="p">(</span><span class="n">C11</span><span class="o">=</span><span class="n">mat_ref</span><span class="o">.</span><span class="n">C11</span><span class="p">,</span> <span class="n">C12</span><span class="o">=</span><span class="n">mat_ref</span><span class="o">.</span><span class="n">C12</span><span class="p">,</span> <span class="n">C44</span><span class="o">=</span><span class="n">mat_ref</span><span class="o">.</span><span class="n">C44</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">elasticity</span><span class="p">(</span><span class="n">CV</span><span class="o">=</span><span class="n">mat_ref</span><span class="o">.</span><span class="n">CV</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plasticity</span><span class="p">(</span><span class="n">sy</span><span class="o">=</span><span class="n">mat_ref</span><span class="o">.</span><span class="n">sy</span><span class="p">,</span> <span class="n">sdim</span><span class="o">=</span><span class="n">mat_ref</span><span class="o">.</span><span class="n">sdim</span><span class="p">)</span>
                <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_sig_data</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">Nlc</span><span class="p">,</span> <span class="n">mat_ref</span><span class="o">=</span><span class="n">mat_ref</span><span class="p">,</span> <span class="n">Nseq</span><span class="o">=</span><span class="n">Nseq</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training data created from reference material&#39;</span><span class="p">,</span><span class="n">mat_ref</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;, with&#39;</span><span class="p">,</span><span class="n">Nlc</span><span class="p">,</span><span class="s1">&#39;load cases.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># based on given yield stresses</span>
                <span class="n">Nlc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sdata</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">sig_eq_j2</span><span class="p">(</span><span class="n">sdata</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plasticity</span><span class="p">(</span><span class="n">sy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="n">sdim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sdata</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]))</span>
                <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_sig_data</span><span class="p">(</span><span class="n">sdata</span><span class="o">=</span><span class="n">sdata</span><span class="p">,</span>  <span class="n">Nseq</span><span class="o">=</span><span class="n">Nseq</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training data created from </span><span class="si">{}</span><span class="s1">-dimensional yield stresses with </span><span class="si">{}</span><span class="s1"> load cases.&#39;</span>\
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">,</span><span class="n">Nlc</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span> <span class="k">else</span> <span class="mi">6</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Nlc</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Nlc&#39;</span><span class="p">]</span>
            <span class="n">Npl</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Npl&#39;</span><span class="p">]</span>
            <span class="n">Ntext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Ntext&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">extend</span><span class="p">:</span>
                <span class="n">Ne</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Ne</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">N0</span> <span class="o">=</span> <span class="n">Nlc</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Nseq</span><span class="o">+</span><span class="n">Ne</span><span class="p">)</span> <span class="c1"># total number of training data points per level of PEEQ for each microstructure</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="p">:</span>
                <span class="n">Nt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="o">*</span><span class="n">Ntext</span><span class="o">*</span><span class="n">Npl</span><span class="o">*</span><span class="n">N0</span> <span class="c1"># total number of training data points</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Nt</span> <span class="o">=</span> <span class="n">Ntext</span><span class="o">*</span><span class="n">Npl</span><span class="o">*</span><span class="n">N0</span>
            <span class="n">xt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="p">))</span>
            <span class="n">yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nt</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">ms</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntext</span><span class="p">):</span>    <span class="c1"># loop over all textures</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Npl</span><span class="p">):</span>  <span class="c1"># loop over work hardening levels for each texture</span>
                        <span class="c1">#create training data in entire deviatoric stress plane from raw data</span>
                        <span class="c1">#training data generated here is unscaled</span>
                        <span class="c1">#work hardening parameters are corrected for offset</span>
                        <span class="n">sc_train</span><span class="p">,</span> <span class="n">yf_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_sig_data</span><span class="p">(</span><span class="n">sdata</span><span class="o">=</span><span class="n">ms</span><span class="p">[</span><span class="s1">&#39;flow_stress&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">,:,:],</span> 
                                            <span class="n">sflow</span><span class="o">=</span><span class="n">ms</span><span class="p">[</span><span class="s1">&#39;flow_seq_av&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">Nseq</span><span class="o">=</span><span class="n">Nseq</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1">#sc_test, yf_test   = self.create_sig_data(sdata=self.msparam[&#39;flow_stress&#39;][k,j,::12,:], Nseq=15, rand=False)</span>
                        <span class="n">i0</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">k</span><span class="o">*</span><span class="n">Npl</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">Ntext</span><span class="p">)</span><span class="o">*</span><span class="n">N0</span>
                        <span class="n">i1</span> <span class="o">=</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">N0</span>
                        <span class="n">xt</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc_train</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="p">:</span>
                            <span class="c1">#Add DOF for work hardening parameter, corrected for offset</span>
                            <span class="n">xt</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms</span><span class="p">[</span><span class="s1">&#39;work_hard&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epc</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="p">:</span>
                            <span class="c1">#Add DOF for textures</span>
                            <span class="n">ih</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ind_tx</span>
                            <span class="n">xt</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span><span class="n">ih</span><span class="o">+</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms</span><span class="p">[</span><span class="s1">&#39;texture&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                        <span class="n">yt</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">yf_train</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> training data sets created from </span><span class="si">%i</span><span class="s1"> microstructures, with </span><span class="si">%i</span><span class="s1"> load cases each&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Nt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">,</span> <span class="n">Nlc</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span><span class="o">&lt;=</span><span class="mf">0.99</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;train_SVC: result vector for yield function contains more categories than &quot;-1&quot; and &quot;+1&quot;. Will result in higher dimensional SVC.&#39;</span><span class="p">)</span>
        <span class="c1">#Train SVC with data from all microstructures in data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># assuming cylindrical stresses if sdim=3</span>
            <span class="n">train_sc</span><span class="p">,</span> <span class="n">test_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_yf_SVM_3D</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span> \
                                <span class="n">fs</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gridsearch</span><span class="o">=</span><span class="n">gridsearch</span><span class="p">,</span> <span class="n">cvals</span><span class="o">=</span><span class="n">cvals</span><span class="p">,</span> <span class="n">gvals</span><span class="o">=</span><span class="n">gvals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">train_sc</span><span class="p">,</span> <span class="n">test_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_yf_SVM_6D</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span> <span class="n">gridsearch</span><span class="o">=</span><span class="n">gridsearch</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training set score: </span><span class="si">{}</span><span class="s2"> %&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_sc</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="c1">#plot ML yield loci with reference and test data</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Plot ML yield loci with reference curve and test data&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial yield locus plotted together with flow stresses for PEEQ in range [</span><span class="si">%6.3f</span><span class="s1">,</span><span class="si">%6.3f</span><span class="s1">]&#39;</span> 
                      <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;work_hard&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;work_hard&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial yield locus plotted for texture parameter in range [</span><span class="si">%6.3f</span><span class="s1">,</span><span class="si">%6.3f</span><span class="s1">]&#39;</span> 
                      <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;texture&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;texture&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">Npl</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># only plot initial yield surface</span>

            <span class="n">ncol</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Npl</span><span class="o">*</span><span class="n">Ntext</span><span class="o">/</span><span class="n">ncol</span> <span class="o">+</span> <span class="mf">0.95</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="n">nrow</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">36</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntext</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_texture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;texture&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">verb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Npl</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">Npl</span><span class="o">/</span><span class="mi">5</span><span class="p">))):</span>
                    <span class="c1">#to-do: x_test and y_test should be setup properly above!!!</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">Npl</span><span class="p">)</span><span class="o">*</span><span class="n">N0</span><span class="p">,(</span><span class="n">j</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">Npl</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">N0</span><span class="o">/</span><span class="n">Nlc</span><span class="p">)))</span>
                    <span class="n">y_test</span> <span class="o">=</span> <span class="n">yt</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="n">x_test</span> <span class="o">=</span> <span class="n">xt</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span>
                    <span class="n">peeq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;work_hard&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epc</span>
                    <span class="n">sflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sflow</span><span class="p">(</span><span class="n">peeq</span><span class="p">)</span>
                    <span class="n">iel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y_test</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ipl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">y_test</span><span class="o">&gt;=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">x_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">sflow</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">Npl</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_test</span><span class="p">[</span><span class="n">ipl</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_test</span><span class="p">[</span><span class="n">ipl</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test data above yield point&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_test</span><span class="p">[</span><span class="n">iel</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_test</span><span class="p">[</span><span class="n">iel</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;b.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test data below yield point&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">syc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;flow_stress&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">,:,:]</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">syc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;reference yield locus&#39;</span><span class="p">)</span>
                    <span class="c1">#ML yield fct: find norm of princ. stess vector lying on yield surface</span>
                    <span class="n">snorm</span> <span class="o">=</span> <span class="n">sig_cyl2princ</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sflow</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">theta</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find_yloc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">36</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">snorm</span><span class="p">,</span><span class="n">peeq</span><span class="p">),</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">)</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="n">snorm</span><span class="o">*</span><span class="n">x1</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
                    <span class="n">s_yld</span> <span class="o">=</span> <span class="n">sig_eq_j2</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">s_yld</span><span class="p">,</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ML yield locus&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Flow stress, PEEQ=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;work_hard&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;, TP=&#39;</span>
                                  <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;texture&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="c1">#plt.xlabel(r&#39;$\theta$ (rad)&#39;, fontsize=fontsize-2)</span>
                    <span class="c1">#plt.ylabel(r&#39;$\sigma_{eq}$ (MPa)&#39;, fontsize=fontsize-2)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">.95</span><span class="p">,</span><span class="mf">0.85</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Material.create_sig_data"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.create_sig_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_sig_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mat_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Nseq</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sflow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                        <span class="n">offs</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rand</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function to create consistent data sets on the deviatoric stress plane</span>
<span class="sd">        for training or testing of ML yield function. Either the number &quot;N&quot; of raw data points, i.e. load angles, to be </span>
<span class="sd">        generated and a reference material &quot;mat_ref&quot; has to be provided, or a list of raw data points &quot;sdata&quot; with </span>
<span class="sd">        cylindrical stress tensors lying on the yield surface serves as input. Based on the raw data, stress tensors </span>
<span class="sd">        from the yield locus are distributed into the entire deviatoric space, by linear downscaling into the elastic </span>
<span class="sd">        region and upscaling into the plastic region. Data is created in form of cylindrical stresses that lie densly </span>
<span class="sd">        around the expected yield locus and more sparsely in the outer plastic region.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        N    : int</span>
<span class="sd">            Number of load cases (polar angles) to be created (optional,</span>
<span class="sd">            either N and mat_ref or sdata must be provided)</span>
<span class="sd">        mat_ref : object of class ``Material``</span>
<span class="sd">            reference material needed to calculate yield function if only N is provided (optional, ignored if sdata is given)</span>
<span class="sd">        sdata: (N,3) or (N,6) array</span>
<span class="sd">            List of cylindrical stresses (N,3) or Voigt stresses (N,6) lying on yield locus. </span>
<span class="sd">            Based on these yield stresses, training data in entire deviatoric stress space is created</span>
<span class="sd">            (optional, either sdata or N and mat_ref must be provided)</span>
<span class="sd">        Nseq : int</span>
<span class="sd">            Number of training stresses to be generated in the range &#39;offs&#39; to the yield strength (optional, default: 12)</span>
<span class="sd">        sflow : float</span>
<span class="sd">            Expected flow stress of data set (optional, default: self.sy)</span>
<span class="sd">        offs : float</span>
<span class="sd">            Start of range for equiv. stress (optional, default: 0.01)</span>
<span class="sd">        extend : Boolean</span>
<span class="sd">            Create additional data in plastic regime (optional, default: False)</span>
<span class="sd">        rand   : Boolean</span>
<span class="sd">            Chose random load cases (polar angles) (optional, default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        st : (M,2) or (M,6) array</span>
<span class="sd">            Cartesian training stresses, M = N (2 Nseq + Nextend)</span>
<span class="sd">        yt : (M,) array</span>
<span class="sd">            Result vector of categorial yield function (-1 or +1) for supervised training</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">sflow</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
        <span class="k">if</span> <span class="n">sdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mat_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;create_data_sig: Neither sdata nor mat_ref are provided, cannot generate training data&#39;</span><span class="p">)</span>
            <span class="c1"># create regular pattern of stresses in sdim-dimensional stress space</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;create_sig_data: Neither N not theta provided. Continuing with N=36 (sdim=3)&#39;</span><span class="p">)</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="mi">36</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rand</span><span class="p">:</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">sc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span>
                <span class="n">su</span> <span class="o">=</span> <span class="n">sig_cyl2princ</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;create_sig_data: Neither N not theta provided. Continuing with N=300 (sdim=6)&#39;</span><span class="p">)</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="mi">300</span>
                <span class="n">n3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">n6</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="n">n3</span>
                <span class="n">su</span> <span class="o">=</span> <span class="n">sig_dev</span><span class="p">(</span><span class="n">load_cases</span><span class="p">(</span><span class="n">n3</span><span class="p">,</span> <span class="n">n6</span><span class="p">))</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">mat_ref</span><span class="o">.</span><span class="n">find_yloc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">mat_ref</span><span class="o">.</span><span class="n">sy</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">su</span><span class="p">),</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">)</span>
            <span class="n">sdata</span> <span class="o">=</span> <span class="n">sig_dev</span><span class="p">(</span><span class="n">su</span><span class="o">*</span><span class="n">x1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>  <span class="c1"># yield stress tensors representing ground truth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># read stress data as seeding points for generation of further training stresses in entire </span>
            <span class="c1"># sdim-dimensional stress space</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sdata</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">N</span><span class="o">!=</span><span class="n">i</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;create_sig_data: N and dimension of sdata do not agree. Continuing with N =&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mat_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;create_sig_data: using sdata for training, ignoring mat_ref&#39;</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">i</span>
            <span class="sd">&#39;&#39;&#39;if self.sdim==3:</span>
<span class="sd">                sc    = sdata[:,0]</span>
<span class="sd">                theta = sdata[:,1]</span>
<span class="sd">            else:&#39;&#39;&#39;</span>
            <span class="n">sdata</span> <span class="o">=</span> <span class="n">sig_dev</span><span class="p">(</span><span class="n">sdata</span><span class="p">)</span> <span class="c1"># make sure training stresses are purely deviatoric</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">offs</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">Nseq</span><span class="p">)</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">Nseq</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">extend</span><span class="p">:</span>
            <span class="c1"># add training points in plastic regime to avoid fallback of SVC decision fct. to zero</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.4</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">]))</span>
        <span class="n">Nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>  <span class="c1"># numberof training stresses per load case</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">*</span><span class="n">Nd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">))</span>  <span class="c1"># input vector with training stresses</span>
        <span class="n">yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">Nd</span><span class="p">)</span>  <span class="c1"># result vector for supervised learning</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nd</span><span class="p">):</span>
            <span class="n">j0</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">N</span>
            <span class="n">j1</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span>
            <span class="sd">&#39;&#39;&#39;if self.sdim==3:</span>
<span class="sd">                # create regular stress grid in 2-dimensional deviatoric plane of princ. stress space</span>
<span class="sd">                st[j0:j1,0] = seq[i]*sflow</span>
<span class="sd">                st[j0:j1,1] = theta</span>
<span class="sd">                yt[j0:j1] = np.sign(seq[i]*sflow - sc)</span>
<span class="sd">            else:&#39;&#39;&#39;</span>
            <span class="c1"># scale sdata into elastic regime (seq&lt;1) or into plastic regime (seq&gt;=1)</span>
            <span class="n">st</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sdata</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span><span class="o">*</span><span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">yt</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">Nseq</span> <span class="k">else</span> <span class="o">+</span><span class="mf">1.</span>                
        <span class="k">return</span> <span class="n">st</span><span class="p">,</span> <span class="n">yt</span></div>

<div class="viewcode-block" id="Material.setup_fgrad_SVM"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.setup_fgrad_SVM">[docs]</a>    <span class="k">def</span> <span class="nf">setup_fgrad_SVM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_grad_train</span><span class="p">,</span> <span class="n">y_grad_train</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Inititalize and train SVM regression for gradient evaluation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X_grad_train : (N,3) array</span>
<span class="sd">        y_grad_train : (N,) array</span>
<span class="sd">        C     : float</span>
<span class="sd">            Paramater for training of Support Vector Regression (SVR) (optional, default:10)</span>
<span class="sd">        gamma : float</span>
<span class="sd">            Parameter for kernel of SVR (optional, default: 0.1)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="s1">&#39;define support vector regressor parameters&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svm_grad0</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVR</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">cache_size</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">coef0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
              <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shrinking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svm_grad1</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVR</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">cache_size</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">coef0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
              <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shrinking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svm_grad2</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVR</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">cache_size</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">coef0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
              <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shrinking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#fit SVM to training data</span>
        <span class="n">X_grad_train</span> <span class="o">=</span> <span class="n">X_grad_train</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
        <span class="n">gmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">y_grad_train</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">gmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">y_grad_train</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gscale</span> <span class="o">=</span> <span class="n">gmax</span> <span class="o">-</span> <span class="n">gmin</span>
        <span class="n">y_grad_train0</span> <span class="o">=</span> <span class="n">y_grad_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">gscale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_grad_train1</span> <span class="o">=</span> <span class="n">y_grad_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">gscale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y_grad_train2</span> <span class="o">=</span> <span class="n">y_grad_train</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">gscale</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svm_grad0</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_grad_train</span><span class="p">,</span> <span class="n">y_grad_train0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svm_grad1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_grad_train</span><span class="p">,</span> <span class="n">y_grad_train1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svm_grad2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_grad_train</span><span class="p">,</span> <span class="n">y_grad_train2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ML_grad</span> <span class="o">=</span> <span class="kc">True</span></div>
        
<div class="viewcode-block" id="Material.export_MLparam"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.export_MLparam">[docs]</a>    <span class="k">def</span> <span class="nf">export_MLparam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sname</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;../../models/&#39;</span><span class="p">,</span> \
                       <span class="n">descr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The parameters of the trained Ml flow rule (support vectors, dual </span>
<span class="sd">        coefficients, offset and scaling parameters) are written to a csv file</span>
<span class="sd">        that is readable to Abaqus (8 numbers per line).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sname : str</span>
<span class="sd">            Name of script that created this material</span>
<span class="sd">        source : str</span>
<span class="sd">            Source of parameters (optional, default: None)</span>
<span class="sd">        file : str</span>
<span class="sd">            Trunk of filename to which CSV flies are written (optional, default: None)</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to which files are written (optional: default: &#39;../../models/&#39;)</span>
<span class="sd">        descr : list</span>
<span class="sd">            List of names of model parameters used for generating this ML material (optional, default: [])</span>
<span class="sd">        param : list</span>
<span class="sd">            List of values of parameters used for generating this ML material (optional, default: []);</span>
<span class="sd">            descr and param must be of the same size</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        CSV file with name path+file+&#39;-svm.csv&#39; containing </span>
<span class="sd">        support vectors, dual coefficients, and (Ndof, elastic parameters, offset, </span>
<span class="sd">        gamma value, scaling factors) in Abaqus format; and</span>
<span class="sd">        JSON file with name path+file+&#39;-svm_meta.json&#39; containing meta data in given format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">get_distribution</span>
        <span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dump</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;export_MLparam: No ML flow rule defined.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epc</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="o">&gt;</span><span class="mi">9</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;export_MLparam: Too many sets to export.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">descr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">descr</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Lists for descr and param must have the same lengths.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;abq_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">file</span>
        
        <span class="c1"># write parameters of trained SVC to file readable to Abaqus</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">dual_coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># dual coefficients</span>
        <span class="n">nsv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>   <span class="c1"># number of support vectors</span>
        <span class="n">nlin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">nsv</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">30</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">Ndata</span> <span class="o">=</span> <span class="n">nlin</span><span class="o">*</span><span class="mi">8</span> <span class="c1"># Number of data points to write</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Ndata</span><span class="p">)</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsv</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C11</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C12</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C44</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">intercept_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gam_yf</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epc</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_wh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CV</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">props</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">props</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CV</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">props</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CV</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">props</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">props</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CV</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">props</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CV</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">props</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CV</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">16</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_text</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">29</span><span class="p">:</span><span class="mi">29</span><span class="o">+</span><span class="n">nsv</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nsv</span><span class="o">+</span><span class="mi">29</span> <span class="c1"># last entry of support vectors</span>
        <span class="n">props</span><span class="p">[</span><span class="mi">29</span><span class="o">+</span><span class="n">nsv</span><span class="p">:</span><span class="n">nl</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">support_vectors_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">file</span><span class="o">+</span><span class="s1">&#39;-svm.csv&#39;</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nlin</span><span class="p">,</span><span class="mi">8</span><span class="p">)),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># paramaters for metadata</span>
        <span class="n">today</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>  <span class="c1"># date</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>  <span class="c1"># username</span>
        <span class="n">sys_info</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">uname</span><span class="p">()</span>  <span class="c1"># system information</span>
        <span class="k">if</span> <span class="n">descr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">descr</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;Ndata&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">])</span>
        <span class="n">param</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Ndata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gam_yf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_yf</span><span class="p">])</span>
        
        <span class="c1"># Create metadata</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">&quot;Info&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;Owner&quot;</span>       <span class="p">:</span> <span class="n">owner</span><span class="p">,</span>
              <span class="s2">&quot;Institution&quot;</span> <span class="p">:</span> <span class="s2">&quot;ICAMS, Ruhr University Bochum, Germany&quot;</span><span class="p">,</span> 
              <span class="s2">&quot;Date&quot;</span>        <span class="p">:</span> <span class="n">today</span><span class="p">,</span>
              <span class="s2">&quot;Description&quot;</span> <span class="p">:</span> <span class="s2">&quot;SVC-parameters for plasticity model&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Method&quot;</span>      <span class="p">:</span> <span class="s2">&quot;Support Vector Classification&quot;</span><span class="p">,</span>
              <span class="s2">&quot;System&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;sysname&quot;</span>  <span class="p">:</span> <span class="n">sys_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="s2">&quot;nodename&quot;</span> <span class="p">:</span> <span class="n">sys_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                  <span class="s2">&quot;release&quot;</span>  <span class="p">:</span> <span class="n">sys_info</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                  <span class="s2">&quot;version&quot;</span>  <span class="p">:</span> <span class="n">sys_info</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                  <span class="s2">&quot;machine&quot;</span>  <span class="p">:</span> <span class="n">sys_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]},</span>
              <span class="p">},</span>
          <span class="s2">&quot;Model&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Creator&quot;</span>   <span class="p">:</span> <span class="s2">&quot;pylabfea&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Version&quot;</span>   <span class="p">:</span> <span class="n">get_distribution</span><span class="p">(</span><span class="s1">&#39;pylabfea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="s2">&quot;Repository&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/AHartmaier/pyLabFEA.git&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Input&quot;</span>     <span class="p">:</span> <span class="n">source</span><span class="p">,</span>
            <span class="s2">&quot;Script&quot;</span>    <span class="p">:</span> <span class="n">sname</span><span class="p">,</span>
            <span class="s2">&quot;Names&quot;</span>     <span class="p">:</span> <span class="n">descr</span><span class="p">,</span>
            <span class="s2">&quot;Parameters&quot;</span><span class="p">:</span> <span class="n">param</span>
            <span class="p">},</span>
          <span class="s2">&quot;Data&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;Class&quot;</span>    <span class="p">:</span> <span class="s1">&#39;SVC_parameters&#39;</span><span class="p">,</span>
              <span class="s2">&quot;Type&quot;</span>     <span class="p">:</span> <span class="s1">&#39;CSV&#39;</span><span class="p">,</span>
              <span class="s2">&quot;File&quot;</span>     <span class="p">:</span> <span class="n">file</span><span class="o">+</span><span class="s1">&#39;-svm.csv&#39;</span><span class="p">,</span>
              <span class="s2">&quot;Separator&quot;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span>
              <span class="s2">&quot;Header&quot;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
              <span class="s2">&quot;Format&quot;</span>   <span class="p">:</span> <span class="p">(</span><span class="n">nlin</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
              <span class="s2">&quot;Names&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nsv&#39;</span><span class="p">,</span> <span class="s1">&#39;nsd&#39;</span><span class="p">,</span> <span class="s1">&#39;C11&#39;</span><span class="p">,</span> <span class="s1">&#39;C12&#39;</span><span class="p">,</span> <span class="s1">&#39;C44&#39;</span><span class="p">,</span> <span class="s1">&#39;rho&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;epc&#39;</span><span class="p">,</span> \
                            <span class="s1">&#39;scale_seq&#39;</span><span class="p">,</span> <span class="s1">&#39;scale_wh&#39;</span><span class="p">,</span> <span class="s1">&#39;C22&#39;</span><span class="p">,</span> <span class="s1">&#39;C33&#39;</span><span class="p">,</span> <span class="s1">&#39;C13&#39;</span><span class="p">,</span> <span class="s1">&#39;C23&#39;</span><span class="p">,</span> \
                            <span class="s1">&#39;C55&#39;</span><span class="p">,</span> <span class="s1">&#39;C66&#39;</span><span class="p">,</span> <span class="s1">&#39;Nset&#39;</span><span class="p">,</span> <span class="s1">&#39;scale_text[0:Nset]&#39;</span><span class="p">,</span> \
                            <span class="s1">&#39;dual_coef[0:nsv]&#39;</span><span class="p">,</span> <span class="s1">&#39;sup_vec[0:nsv,0:nsd]&#39;</span><span class="p">],</span>
              <span class="s2">&quot;Units&quot;</span> <span class="p">:</span> <span class="p">{</span> 
                  <span class="s1">&#39;Stress&#39;</span> <span class="p">:</span> <span class="s1">&#39;MPa&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Strain&#39;</span> <span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Disp&#39;</span>   <span class="p">:</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Force&#39;</span>  <span class="p">:</span> <span class="s1">&#39;N&#39;</span><span class="p">}</span>
              <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="o">+</span><span class="s1">&#39;-svm_meta.json&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="Material.pckl"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.pckl">[docs]</a>    <span class="k">def</span> <span class="nf">pckl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;../../materials/&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write material into pickle file. Usefull for materials with trained machine </span>
<span class="sd">        learning flow rules to avoid time-consuming re-training.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : string (optional, default: None)</span>
<span class="sd">            File name for pickled material. The default is None, in which case </span>
<span class="sd">            the filename will be the material name + &#39;.pckl&#39;. </span>
<span class="sd">        path : string</span>
<span class="sd">            Path to location for pickles</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;mat_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="k">return</span></div>


    <span class="c1">#=========================================================</span>
    <span class="c1"># subroutines for material definitions</span>
    <span class="c1">#=========================================================</span>
<div class="viewcode-block" id="Material.elasticity"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.elasticity">[docs]</a>    <span class="k">def</span> <span class="nf">elasticity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C11</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C12</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C44</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># standard parameters for crystals with cubic symmetry</span>
                   <span class="n">CV</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                            <span class="c1"># user specified Voigt matrix</span>
                   <span class="n">E</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                   <span class="c1"># parameters for isotropic material</span>
        <span class="sd">&#39;&#39;&#39;Define elastic material properties</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        C11 : float</span>
<span class="sd">        C12 : float</span>
<span class="sd">        C44 : float</span>
<span class="sd">            Anisoptropic elastic constants of material (optional,</span>
<span class="sd">            if (C11,C12,C44) not given, either (E,nu) or CV must be specified)</span>
<span class="sd">        E   : float</span>
<span class="sd">        nu  : float</span>
<span class="sd">            Isotropic parameters Young&#39;s modulus and Poisson&#39;s number (optional,</span>
<span class="sd">            if (E,nu) not given, either (C11,C12,C44) or CV must be specified)</span>
<span class="sd">        CV  : (6,6) array</span>
<span class="sd">            Voigt matrix of elastic constants (optional, if CV not given, either</span>
<span class="sd">            (C11,C12,C44) or (E,nu) must be specified)</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">E</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error: Inconsistent definition of material parameters: Only E provided&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">C11</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">C12</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">C44</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error: Inconsistent definition of material parameters: E provided together with C_ij&#39;</span><span class="p">)</span>
            <span class="n">hh</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">((</span><span class="mf">1.</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">nu</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C11</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">hh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C12</span> <span class="o">=</span> <span class="n">nu</span><span class="o">*</span><span class="n">hh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C44</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">hh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">E</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">C11</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error: Inconsistent definition of material parameters: nu provided together with C_ij&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">C12</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">C44</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error: Inconsistent definition of material parameters: C_12 or C_44 values missing&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C11</span> <span class="o">=</span> <span class="n">C11</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C12</span> <span class="o">=</span> <span class="n">C12</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C44</span> <span class="o">=</span> <span class="n">C44</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="n">C12</span><span class="o">/</span><span class="p">(</span><span class="n">C11</span><span class="o">+</span><span class="n">C12</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">C44</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nu</span><span class="p">)</span> <span class="c1"># only for isotropy, might be used for plane stress models</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CV</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1">#warnings.warn(&#39;elasticity: E and nu calculated from anisotropic elastic parameters&#39;)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">CV</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">CV</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C11</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C44</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CV</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C12</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C11</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">C12</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">C44</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nu</span><span class="p">)</span> <span class="c1"># only for isotropy, might be used for plane stress models</span>
            <span class="c1">#warnings.warn(&#39;elasticity: E and nu calculated from anisotropic elastic parameters&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;elasticity: Inconsistent definition of material parameters&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Material.plasticity"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.plasticity">[docs]</a>    <span class="k">def</span> <span class="nf">plasticity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hill</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drucker</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">khard</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">tresca</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">barlat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> \
                   <span class="n">barlat_exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hill_3p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hill_6p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sdim</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Define plastic material parameters; anisotropic Hill-like and Drucker-like</span>
<span class="sd">        behavior is supported</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sy   : float</span>
<span class="sd">            Yield strength</span>
<span class="sd">        hill : (3,) array</span>
<span class="sd">            Parameters for Hill-like orthotropic anisotropy (optional, default: isotropy)</span>
<span class="sd">        drucker : float</span>
<span class="sd">            Parameter for Drucker-like tension-compression asymmetry (optional, default: 0)</span>
<span class="sd">        khard: float</span>
<span class="sd">            Linear strain hardening slope (ds/de_p) (optional, default: 0)</span>
<span class="sd">        tresca : Boolean</span>
<span class="sd">            Indicate if Tresca equivalent stress should be used (optional, default: False)</span>
<span class="sd">        barlat : (18,) array</span>
<span class="sd">            Array with parameters for Barlat Yld2004-18p yield function (optional)</span>
<span class="sd">        barlat_exp : int</span>
<span class="sd">            Exponent for Barlat Yld2004-18p yield function (optional)</span>
<span class="sd">        hill_3p : Boolean</span>
<span class="sd">            Indicate if 3-parameter Hill model shall be applied (optional, default: None)</span>
<span class="sd">            Will be set True automatically if 3 Hill paramaters != 1 are provided </span>
<span class="sd">        hill_6p : Boolean</span>
<span class="sd">            Indicate if 6-parameter Hill model shall be applied (optional, default: None)</span>
<span class="sd">            Will be set True automatically if 6 Hill parameters are provided</span>
<span class="sd">        sdim : int</span>
<span class="sd">            Dimensionality of stress tensor to be used for plasticity, must be either 3 </span>
<span class="sd">            (only principal stresses are considered) or 6 (full stress tensor is considered),</span>
<span class="sd">            (optional, default: 6)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sy0</span> <span class="o">=</span> <span class="n">sy</span>  <span class="c1"># store initial yield strength of material</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sy</span> <span class="o">=</span> <span class="n">sy</span>   <span class="c1"># current yield strength (may be modified by texture)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">khard</span> <span class="o">=</span> <span class="n">khard</span> <span class="c1"># strain hardening slope (d flow stress / d plastic strain)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drucker</span> <span class="o">=</span> <span class="n">drucker</span>   <span class="c1"># Drucker-Prager parameter: weight of hydrostatic stress</span>
        <span class="k">if</span> <span class="n">sdim</span><span class="o">!=</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">sdim</span><span class="o">!=</span><span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> in plasticity: sdim must be either 3 or 6&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">!=</span><span class="n">sdim</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plasticity: Parameter sdim is changed. New value:&#39;</span><span class="p">,</span><span class="n">sdim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span> <span class="o">=</span> <span class="n">sdim</span>
        <span class="k">if</span> <span class="n">hill</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">)</span>
        <span class="n">lh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hill</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hill_6p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hill_3p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># determine if 3 or 6 Hill parameters are provided</span>
            <span class="n">hill_6p</span> <span class="o">=</span> <span class="p">(</span><span class="n">lh</span><span class="o">==</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">hill_3p</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">hill_6p</span>
            <span class="k">if</span> <span class="n">hill_3p</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hill</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mf">1.</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hill</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mf">1.</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hill</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mf">1.</span><span class="p">):</span>
                <span class="n">hill_3p</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">hill_6p</span> <span class="ow">and</span> <span class="n">lh</span><span class="o">!=</span><span class="mi">6</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;plasticity: When hill_6p is set True, 6 Hill parameters must be provided&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hill_3p</span> <span class="ow">and</span> <span class="n">lh</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;plasticity: When hill_3p is set True, only 3 Hill parameters can be provided&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hill_6p</span> <span class="ow">and</span> <span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;plasticity: 6 Hill parameters are provided, but sdim=3; ignoring shear parameters&#39;</span><span class="p">)</span>
            <span class="n">hill_6p</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">hill_3p</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">hill</span> <span class="o">=</span> <span class="n">hill</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hill_3p</span> <span class="ow">and</span> <span class="n">sdim</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Material&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;plasticity: 3 Hill parameters are provided, but sdim=6; shear parameters set to 1&#39;</span><span class="p">)</span>
            <span class="n">hill_3p</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">hill_6p</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">hill</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sdim</span><span class="o">==</span><span class="mi">6</span> <span class="ow">and</span> <span class="n">lh</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">hill</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hill_6p</span> <span class="o">=</span> <span class="n">hill_6p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hill_3p</span> <span class="o">=</span> <span class="n">hill_3p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hill</span><span class="p">)</span>  <span class="c1"># Hill anisotropic parameters</span>
        <span class="c1"># set Trseca flag</span>
        <span class="k">if</span> <span class="n">tresca</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tresca</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tresca</span> <span class="o">=</span> <span class="n">tresca</span>
        <span class="k">if</span> <span class="n">barlat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">barlat</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Bar_m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span>      <span class="mf">0.</span><span class="p">,</span>     <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>     <span class="mf">0.</span><span class="p">,</span>       <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
                         <span class="p">[</span> <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>     <span class="mf">0.</span><span class="p">,</span>     <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>     <span class="mf">0.</span><span class="p">,</span>         <span class="mf">0.</span><span class="p">,</span>       <span class="mf">0.</span><span class="p">],</span>
                         <span class="p">[</span> <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>  <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>    <span class="mf">0.</span><span class="p">,</span>         <span class="mf">0.</span><span class="p">,</span>         <span class="mf">0.</span><span class="p">,</span>       <span class="mf">0.</span><span class="p">],</span>
                         <span class="p">[</span>   <span class="mf">0.</span><span class="p">,</span>           <span class="mf">0.</span><span class="p">,</span>         <span class="mf">0.</span><span class="p">,</span>      <span class="n">barlat</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>     <span class="mf">0.</span><span class="p">,</span>       <span class="mf">0.</span><span class="p">],</span>
                         <span class="p">[</span>   <span class="mf">0.</span><span class="p">,</span>           <span class="mf">0.</span><span class="p">,</span>         <span class="mf">0.</span><span class="p">,</span>         <span class="mf">0.</span><span class="p">,</span>       <span class="n">barlat</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>  <span class="mf">0.</span><span class="p">],</span>
                         <span class="p">[</span>   <span class="mf">0.</span><span class="p">,</span>           <span class="mf">0.</span><span class="p">,</span>         <span class="mf">0.</span><span class="p">,</span>         <span class="mf">0.</span><span class="p">,</span>         <span class="mf">0.</span><span class="p">,</span>   <span class="n">barlat</span><span class="p">[</span><span class="mi">8</span><span class="p">]]])</span>
        
            <span class="c1">#  Cdouble dash matrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Bar_m2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span>   <span class="mf">0.</span><span class="p">,</span>  <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>  <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>   <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
                         <span class="p">[</span> <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>   <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
                         <span class="p">[</span> <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>  <span class="o">-</span><span class="n">barlat</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span>    <span class="mf">0.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
                         <span class="p">[</span>   <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="n">barlat</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
                         <span class="p">[</span>   <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span> <span class="n">barlat</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>  <span class="mf">0.</span><span class="p">],</span>
                         <span class="p">[</span>   <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="n">barlat</span><span class="p">[</span><span class="mi">17</span><span class="p">]]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">barlat_exp</span> <span class="o">=</span> <span class="n">barlat_exp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">barlat</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Material.from_data"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.from_data">[docs]</a>    <span class="k">def</span> <span class="nf">from_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Define material properties from data sets generated in module `Data`: </span>
<span class="sd">        containes data on elastic and plastic behavior, including work hardening, </span>
<span class="sd">        for different crystallographic textures. Possible to extend to grain sizes, </span>
<span class="sd">        grain shapes and porosities. Will invoke definition of elastic and plastic </span>
<span class="sd">        parameters by calls to the methods `Material.elasticity` and `Material.plasticity` </span>
<span class="sd">        with the parameters provided in the data set. </span>
<span class="sd">        Also initializes current texture to first one in list and resets work hardening </span>
<span class="sd">        parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        param : list or directories</span>
<span class="sd">            `Data.mat_param` directories containing material data sets</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">#import dictionaries with all microstructure parameters resulting from data module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">)</span>  <span class="c1"># number of microstructures in material definition</span>
        <span class="n">Nlc</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Nlc&#39;</span><span class="p">]</span>
        <span class="n">Npl</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Npl&#39;</span><span class="p">]</span>
        <span class="n">Ntext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Ntext&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sdim&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sdim&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sdim&#39;</span><span class="p">]</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;from_data: Microstructure has changed definition of sdim. New value=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">!=</span><span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">!=</span><span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value of sdim must be either 3 or 6&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epc</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;epc&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">):</span>
            <span class="n">h1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;Nlc&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Nlc</span>
            <span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;Npl&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Npl</span>
            <span class="n">h3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;Ntext&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Ntext</span>
            <span class="n">h4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;sdim&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span>
            <span class="k">if</span> <span class="n">h1</span> <span class="ow">or</span> <span class="n">h2</span> <span class="ow">or</span> <span class="n">h3</span> <span class="ow">or</span> <span class="n">h4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: Structure of data set #&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39; is inconsistent:&#39;</span><span class="p">,</span> <span class="n">Nlc</span><span class="p">,</span> <span class="n">Npl</span><span class="p">,</span> <span class="n">Ntext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">h4</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Inconsistent data structure&#39;</span><span class="p">)</span>
                <span class="c1">#Conditions can be relaxed by modifying train_SVC</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;epc&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epc</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Inconsistent definition of yield onset in texture </span><span class="si">{}</span><span class="s1">. Using eps_cr=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="n">Npl</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">True</span>    <span class="c1"># work hardening data exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="n">Ntext</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">True</span>  <span class="c1"># texture variations exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span> <span class="k">else</span> <span class="mi">6</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whdat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ind_wh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span>  <span class="c1"># index for dof associated with work hardening</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span> <span class="o">+=</span> <span class="mi">1</span>           <span class="c1"># add dof for work hardening parameter if data exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">txdat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ind_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span>  <span class="c1"># starting index for dof associated with textures</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span>   <span class="c1"># add dof&#39;s for textures</span>
            
        <span class="c1"># assign average properties to material and initialize texture and work-hardening</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elasticity</span><span class="p">(</span><span class="n">E</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;E_av&#39;</span><span class="p">],</span> <span class="n">nu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nu_av&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plasticity</span><span class="p">(</span><span class="n">sy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sy_av&#39;</span><span class="p">],</span> <span class="n">sdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">)</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">)</span>
        <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_texture</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="Material.from_MLparam"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.from_MLparam">[docs]</a>    <span class="k">def</span> <span class="nf">from_MLparam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;../../models/&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Define material properties from parameters of trained machine learning </span>
<span class="sd">        models that have been written with `Material.export_MLparam`.</span>
<span class="sd">        Will invoke definition of elastic parameters by calls to the methods </span>
<span class="sd">        `Material.elasticity` with the parameters provided in the data set. </span>
<span class="sd">        Also initializes current texture to first one in list and resets work hardening</span>
<span class="sd">        parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : string</span>
<span class="sd">            Name of parameter files (`name`.csv file and metadata file `name_meta.json`)</span>
<span class="sd">        path : string</span>
<span class="sd">            Path in which files are stored (optional, default: &#39;../../models/&#39;)            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="s1">&#39;Import from ML parameters not yet implemented.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Material.set_texture"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.set_texture">[docs]</a>    <span class="k">def</span> <span class="nf">set_texture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set parameters for current crystallographic texture of material as defined in microstructure.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        current : float or list</span>
<span class="sd">            Mixture parameter for microstructures in range [0,1] for each defined microstructure, indicates the </span>
<span class="sd">            intensity of the given microstructure. The sum of all mixture parameters must be &lt;=1, the rest will be set </span>
<span class="sd">            to random texture. Must have same dimension as material.msparam.</span>
<span class="sd">        verb : Boolean</span>
<span class="sd">            Be verbose </span>
<span class="sd">            </span>
<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        Material.tx_cur : list</span>
<span class="sd">            Current value of microstructural mixture parameter for active microstructure. Has same dimension as material.msparam</span>
<span class="sd">        Material.sy  : float</span>
<span class="sd">            Yield stength is redefined accoring to texture parameter</span>
<span class="sd">        Material.khard : float</span>
<span class="sd">            Work hardening parameter is redefined according to texture parameter</span>
<span class="sd">        Material.epc : float</span>
<span class="sd">            Critical PEEQ for which onset of plastic deformation is definied in data</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="p">)</span> <span class="c1"># sum of mixture parameters</span>
        <span class="k">if</span> <span class="n">sm</span><span class="o">&gt;</span><span class="mf">1.</span> <span class="ow">or</span> <span class="n">sm</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: Microstructure parameters out of range:&#39;</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;set_texture: Bad value for mixture parameter&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: Microstructure parameters have wrong dimension:&#39;</span><span class="p">,</span><span class="n">current</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;set_texture: Wrong dimension of mixture parameter&#39;</span><span class="p">)</span>
        <span class="c1">#calculate weight factor for each texture based on its mixture parameter</span>
        <span class="k">if</span> <span class="n">sm</span><span class="o">&lt;</span><span class="mf">1.e-3</span><span class="p">:</span>
            <span class="n">wght</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wght</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="o">/</span><span class="n">sm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sy</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="c1">#self.khard = 0.</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ms</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">):</span>
            <span class="n">hh</span> <span class="o">=</span> <span class="n">ms</span><span class="p">[</span><span class="s1">&#39;texture&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">hh</span><span class="p">)))</span>
            <span class="c1">#redefine plasticity parameters according to texture parameter</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ms</span><span class="p">[</span><span class="s1">&#39;texture&#39;</span><span class="p">],</span> <span class="n">ms</span><span class="p">[</span><span class="s1">&#39;flow_seq_av&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sy</span>  <span class="o">+=</span> <span class="n">sy</span><span class="o">*</span><span class="n">wght</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="sd">&#39;&#39;&#39;if self.whdat:</span>
<span class="sd">                #set strain hardening parameters to initial value for selected texture</span>
<span class="sd">                ds = ms[&#39;flow_seq_av&#39;][index[-1],1] - ms[&#39;flow_seq_av&#39;][index[-1],0] # assuming isotropic hardening</span>
<span class="sd">                de = ms[&#39;work_hard&#39;][1] - ms[&#39;work_hard&#39;][0]</span>
<span class="sd">                khard   =  ds/de # linear work hardening rate b/w values for w.h. in data</span>
<span class="sd">                self.khard += khard*wght[i]&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New texture parameters: &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Texture mixing: &#39;</span><span class="p">)</span>
            <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msparam</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ms_type&#39;</span><span class="p">],</span><span class="s1">&#39;with mixture parameter&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_cur</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">)]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Yield strength:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="p">,</span><span class="s1">&#39;MPa&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms_index</span> <span class="o">=</span> <span class="n">index</span></div>
            
    <span class="c1">#==============================================================</span>
    <span class="c1"># subroutines for post-processing and graphics</span>
    <span class="c1">#==============================================================</span>
    
<div class="viewcode-block" id="Material.ellipsis"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.ellipsis">[docs]</a>    <span class="k">def</span> <span class="nf">ellipsis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="mi">72</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create ellipsis with main axis along 45° axis, used for graphical representation of isotropic yield locus.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a : float</span>
<span class="sd">            Long half-axis of ellipsis (optional, default: 1)</span>
<span class="sd">        a : float</span>
<span class="sd">            Short half-axis of ellipsis (optional, default: 1/sqrt(3))</span>
<span class="sd">        n : int</span>
<span class="sd">            Number of points on ellipsis to be calculated</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        x, y : (n,) arrayy</span>
<span class="sd">            x and y coordinates of points on ellipsis</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">2.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>

<div class="viewcode-block" id="Material.plot_data"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.plot_data">[docs]</a>    <span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Plotting data in stress space to visualize yield loci.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Z   : array</span>
<span class="sd">            Data for field plot</span>
<span class="sd">        axs : handle</span>
<span class="sd">            Axes where plot is added</span>
<span class="sd">        xx  : meshgrid</span>
<span class="sd">            x-coordinates</span>
<span class="sd">        yy  : meshgrid</span>
<span class="sd">            y-coordinates</span>
<span class="sd">        field : Boolean</span>
<span class="sd">            Decide if field is plotted (optional, default: True)</span>
<span class="sd">        c   : str</span>
<span class="sd">            Color for contour line (optional, default: &#39;red&#39;)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        line : handle</span>
<span class="sd">            Reference to plotted line</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#symmetrize Z values</span>
        <span class="n">zmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">zmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">zmin</span> <span class="o">&lt;</span> <span class="n">zmax</span><span class="p">):</span>
            <span class="n">Z</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Z</span><span class="o">&gt;-</span><span class="n">zmin</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">zmin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Z</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Z</span><span class="o">&lt;-</span><span class="n">zmax</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">zmax</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1">#display data</span>
        <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
               <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
               <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">PuOr_r</span><span class="p">)</span>
        <span class="n">contour</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">collections</span>
        <span class="k">return</span> <span class="n">line</span></div>

<div class="viewcode-block" id="Material.plot_yield_locus"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.plot_yield_locus">[docs]</a>    <span class="k">def</span> <span class="nf">plot_yield_locus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trange</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                         <span class="n">xstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iso</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ref_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">Nmesh</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Plot different cuts through yield locus in 3D principal stress space.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fun   : function handle</span>
<span class="sd">            Yield function to be plotted (optional, default: own yield function)</span>
<span class="sd">        label : str</span>
<span class="sd">            Label for yield function (optional, default: own name)</span>
<span class="sd">        data  : (N,3) array</span>
<span class="sd">            principal stress data to be used for scatter plot (optional)</span>
<span class="sd">        trange : float</span>
<span class="sd">            Cut-off for data to be plotted on slice (optional, default: 1.e-2)</span>
<span class="sd">        peeq   : float</span>
<span class="sd">            Level of plastic strain for which yield locus is plotted (isotropic hardening)</span>
<span class="sd">        xstart : float</span>
<span class="sd">            Smallest value on x-axis (optional, default: -2)</span>
<span class="sd">        xend   : float</span>
<span class="sd">            Largest value on x-axis (optional, default: 2)</span>
<span class="sd">        axis1 : list</span>
<span class="sd">            Cartesian stress coordinates to be plotted on x-axis of slices (optional, default: [0])</span>
<span class="sd">        axis2 : list</span>
<span class="sd">            Cartesian stress coordinates to be plotted on y-axis of slices (optional, default: [1])</span>
<span class="sd">        iso   : Boolean</span>
<span class="sd">            Decide if reference ellipsis for isotropic material is plotted (optional, default: False)</span>
<span class="sd">        ref_mat=None</span>
<span class="sd">            Reference material to plot yield locus (optional)</span>
<span class="sd">        field : Boolean</span>
<span class="sd">            Decide if field of yield function is plotted (optional, default: False)</span>
<span class="sd">        Nmesh : int</span>
<span class="sd">            Number of mesh points per axis on which yield function is evaluated (optional, default:100)</span>
<span class="sd">        file  : str</span>
<span class="sd">            File name for output of olot (optional)</span>
<span class="sd">        fontsize : int</span>
<span class="sd">            Fontsize for axis annotations (optional, default: 20)</span>
<span class="sd">        scaling  : Boolean</span>
<span class="sd">            Scale stress with yield strength (optional, default: True)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axs : pyplot axis handle</span>
<span class="sd">            Axis of the plot</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">xstart</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                <span class="n">xstart</span><span class="o">=-</span><span class="mf">2.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xstart</span><span class="o">=-</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
        <span class="k">if</span> <span class="n">xend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                <span class="n">xend</span><span class="o">=</span><span class="mf">2.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xend</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xstart</span><span class="p">,</span> <span class="n">xend</span><span class="p">,</span> <span class="n">Nmesh</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xstart</span><span class="p">,</span> <span class="n">xend</span><span class="p">,</span> <span class="n">Nmesh</span><span class="p">))</span>
        <span class="n">Nm2</span> <span class="o">=</span> <span class="n">Nmesh</span><span class="o">*</span><span class="n">Nmesh</span>
        <span class="n">Nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis2</span><span class="p">)</span><span class="o">!=</span><span class="n">Nc</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error in plot_yield_locus: mismatch in dimensions of ax1 and ax2&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Nc</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">fontsize</span> <span class="o">*=</span> <span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span>  <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">Nc</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1">#loop over subplots in axis1 and axis2</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nc</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Nc</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">lines</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">[]</span>
            <span class="c1">#select slice in 3D stress space</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">s3</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1">#first axis</span>
            <span class="k">if</span> <span class="n">axis1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_1$&#39;</span>
                <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">xlab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_1 / \sigma_y$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xlab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_1$ (MPa)&#39;</span>
            <span class="k">elif</span> <span class="n">axis1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_2$&#39;</span>
                <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">xlab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_2 / \sigma_y$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xlab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_2$ (MPa)&#39;</span>
            <span class="k">elif</span> <span class="n">axis1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">s3</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_3$&#39;</span>
                <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">xlab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_3 / \sigma_y$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xlab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_3$ (MPa)&#39;</span>
            <span class="k">elif</span> <span class="n">axis1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$p=\sigma_1=\sigma_2$&#39;</span>
                <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">xlab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$p / \sigma_y$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xlab</span> <span class="o">=</span> <span class="s1">&#39;$p$ (MPa)&#39;</span>
                <span class="n">ref_mat</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">axis1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;plot_yield_locus: axis1 not defined properly, set to sig_1:</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis1</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_1$&#39;</span>
                <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">xlab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_1 / \sigma_y$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xlab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_1$ (MPa)&#39;</span>
            <span class="c1">#second axis</span>
            <span class="k">if</span> <span class="n">axis2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39;-$\sigma_1$ slice&#39;</span>
                <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">ylab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_1 / \sigma_y$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ylab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_1$ (MPa)&#39;</span>
            <span class="k">elif</span> <span class="n">axis2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39;-$\sigma_2$ slice&#39;</span>
                <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">ylab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_2 / \sigma_y$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ylab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_2$ (MPa)&#39;</span>
            <span class="k">elif</span> <span class="n">axis2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">s3</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39;-$\sigma_3$ slice&#39;</span>
                <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">ylab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_3 / \sigma_y$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ylab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_3$ (MPa)&#39;</span>
            <span class="k">elif</span> <span class="n">axis2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">s3</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39;-$\sigma_3$ slice&#39;</span>
                <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">ylab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_3 / \sigma_y$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ylab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_3$ (MPa)&#39;</span>
                <span class="n">axis2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;plot_yield_locus: axis2 not defined properly, set to sig_2: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis2</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39;-$\sigma_2$ slice&#39;</span>
                <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">ylab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_2 / \sigma_y$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ylab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_2$ (MPa)&#39;</span>
            <span class="n">si3</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># slice for data</span>
            <span class="k">if</span> <span class="n">s1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nm2</span><span class="p">)</span>
                <span class="n">si3</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">s2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nm2</span><span class="p">)</span>
                <span class="n">si3</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">s3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nm2</span><span class="p">)</span>
                <span class="n">si3</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">]</span>  <span class="c1"># set stresses for yield locus calculation</span>

            <span class="c1">#evaluate yield function to be plotted</span>
            <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                <span class="n">sf</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
                <span class="n">sig</span><span class="o">*=</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sf</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="n">fun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">,</span> <span class="n">pred</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span><span class="n">sf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">pred</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span><span class="n">sf</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">hl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hl</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">label</span><span class="p">])</span>
            <span class="c1">#plot reference function if provided</span>
            <span class="k">if</span> <span class="n">ref_mat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">,</span> <span class="n">pred</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span><span class="n">sf</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                <span class="n">hl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hl</span><span class="p">)</span>
            <span class="c1">#plot ellipsis as reference if requested</span>
            <span class="k">if</span> <span class="n">iso</span><span class="p">:</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipsis</span><span class="p">()</span>  <span class="c1"># reference for isotropic material</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">scaling</span><span class="p">:</span>
                    <span class="n">x0</span><span class="o">*=</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
                    <span class="n">y0</span><span class="o">*=</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
                <span class="n">hl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;-b&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hl</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;isotropic J2&#39;</span><span class="p">])</span>
            <span class="c1">#plot data if provided</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># select data from 3D stress space within range [xstart, xend] and to fit to slice</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="n">sf</span>
                <span class="n">dsel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span><span class="n">si3</span><span class="p">])</span><span class="o">&lt;</span><span class="n">trange</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span><span class="n">axis1</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">&gt;</span><span class="n">xstart</span><span class="p">,</span> <span class="n">dat</span><span class="p">[:,</span><span class="n">axis1</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">&lt;</span><span class="n">xend</span><span class="p">)))</span>
                <span class="n">ir</span> <span class="o">=</span> <span class="n">dsel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">yf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_yf</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">ir</span><span class="p">,:],</span> <span class="n">peeq</span><span class="o">=</span><span class="n">peeq</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">ir</span><span class="p">,</span><span class="n">axis1</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">dat</span><span class="p">[</span><span class="n">ir</span><span class="p">,</span><span class="n">axis2</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">yf</span><span class="p">,</span>
                           <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Paired</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
            <span class="c1">#ax.set_title(title,fontsize=fontsize)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">hh</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="n">Nc</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">7</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="n">hh</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="n">hh</span><span class="p">)</span>
        <span class="c1">#save plot to file if filename is provided</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">axs</span></div>

<div class="viewcode-block" id="Material.calc_properties"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.calc_properties">[docs]</a>    <span class="k">def</span> <span class="nf">calc_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">Nel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">min_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                        <span class="n">sigeps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">load_cases</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;stx&#39;</span><span class="p">,</span><span class="s1">&#39;sty&#39;</span><span class="p">,</span><span class="s1">&#39;et2&#39;</span><span class="p">,</span><span class="s1">&#39;ect&#39;</span><span class="p">]):</span>
        <span class="sd">&#39;&#39;&#39;Use pylabfea.model to calculate material strength and stress-strain data along a given load path.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        size : int</span>
<span class="sd">            Size of FE model (optional, defaul: 2)</span>
<span class="sd">        Nel : int</span>
<span class="sd">            Number of elements per axis (optional, defaul: 2)</span>
<span class="sd">        verb : Boolean</span>
<span class="sd">            Be verbose with output (optional, default: False)</span>
<span class="sd">        eps : float</span>
<span class="sd">            Maximum total strain (optional, default:0.005)</span>
<span class="sd">        min_step : int</span>
<span class="sd">            Minumum number of load steps (optional)</span>
<span class="sd">        sigeps : Boolean</span>
<span class="sd">            Decide if data for stress-strain curves in stored in dictionary Material.sigeps (optional, default: False)</span>
<span class="sd">        load_cases : list</span>
<span class="sd">            List of load cases to be performed (optional, default: [&#39;stx&#39;,&#39;sty&#39;,&#39;et2&#39;,&#39;ect&#39;]);</span>
<span class="sd">            &#39;stx&#39;: uniaxial tensile yield stress in horizontal (x-)direction;</span>
<span class="sd">            &#39;sty&#39;: uniaxial tensile yield stress in vertical (y-)direction;</span>
<span class="sd">            &#39;et2&#39;: plane stress, equibiaxial strain in x and y direction;</span>
<span class="sd">            &#39;ect&#39;: pure shear strain (x-compression, y-tension), plane stress</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">calc_strength</span><span class="p">(</span><span class="n">vbc1</span><span class="p">,</span> <span class="n">nbc1</span><span class="p">,</span> <span class="n">vbc2</span><span class="p">,</span> <span class="n">nbc2</span><span class="p">,</span> <span class="n">sel</span><span class="p">):</span>
            <span class="n">fe</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">planestress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fe</span><span class="o">.</span><span class="n">geom</span><span class="p">([</span><span class="n">size</span><span class="p">],</span> <span class="n">LY</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="c1"># define section in absolute length</span>
            <span class="n">fe</span><span class="o">.</span><span class="n">assign</span><span class="p">([</span><span class="bp">self</span><span class="p">])</span>        <span class="c1"># assign material to section</span>
            <span class="n">fe</span><span class="o">.</span><span class="n">bcleft</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>            <span class="c1"># fix lhs nodes in x-direction</span>
            <span class="n">fe</span><span class="o">.</span><span class="n">bcbot</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>             <span class="c1"># fix bottom nodes in y-direction</span>
            <span class="n">fe</span><span class="o">.</span><span class="n">bcright</span><span class="p">(</span><span class="n">vbc1</span><span class="p">,</span> <span class="n">nbc1</span><span class="p">)</span>   <span class="c1"># define BC in x-direction</span>
            <span class="n">fe</span><span class="o">.</span><span class="n">bctop</span><span class="p">(</span><span class="n">vbc2</span><span class="p">,</span> <span class="n">nbc2</span><span class="p">)</span>     <span class="c1"># define BC in y-direction</span>
            <span class="n">fe</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">NX</span><span class="o">=</span><span class="n">Nel</span><span class="p">,</span> <span class="n">NY</span><span class="o">=</span><span class="n">Nel</span><span class="p">)</span>  <span class="c1"># create mesh</span>
            <span class="n">fe</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span><span class="n">min_step</span><span class="o">=</span><span class="n">min_step</span><span class="p">)</span>      <span class="c1"># solve mechanical equilibrium condition under BC</span>
            <span class="n">seq</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_seq</span><span class="p">(</span><span class="n">fe</span><span class="o">.</span><span class="n">sgl</span><span class="p">)</span>   <span class="c1"># store time dependent mechanical data of model</span>
            <span class="n">eeq</span>  <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">fe</span><span class="o">.</span><span class="n">egl</span><span class="p">)</span>
            <span class="n">peeq</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">fe</span><span class="o">.</span><span class="n">epgl</span><span class="p">)</span>
            <span class="n">iys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">peeq</span><span class="o">&lt;</span><span class="mf">1.e-2</span><span class="p">)</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">iys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;ys&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">ys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;seq&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">seq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;eeq&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">eeq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;peeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peeq</span>
            <span class="n">seq</span>  <span class="o">=</span> <span class="n">sig_eq_j2</span><span class="p">(</span><span class="n">fe</span><span class="o">.</span><span class="n">sgl</span><span class="p">)</span>   <span class="c1"># store time dependent mechanical data of model</span>
            <span class="n">eeq</span>  <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">fe</span><span class="o">.</span><span class="n">egl</span><span class="p">)</span>
            <span class="n">peeq</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">fe</span><span class="o">.</span><span class="n">epgl</span><span class="p">)</span>
            <span class="n">iys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">peeq</span><span class="o">&lt;</span><span class="mf">1.e-6</span><span class="p">)</span>  <span class="c1"># take stress at last index of elastic regime</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">iys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propJ2</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;ys&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">ys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propJ2</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;seq&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">seq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propJ2</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;eeq&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">eeq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propJ2</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;peeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peeq</span>
            <span class="k">if</span> <span class="n">sigeps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sigeps</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">sgl</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sigeps</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;eps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">egl</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sigeps</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;epl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">epgl</span>
            <span class="k">return</span>
        <span class="k">def</span> <span class="nf">calc_stx</span><span class="p">():</span>
            <span class="n">u1</span> <span class="o">=</span> <span class="n">eps</span><span class="o">*</span><span class="n">size</span>
            <span class="n">calc_strength</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="s1">&#39;stx&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="s1">&#39;stx&#39;</span><span class="p">][</span><span class="s1">&#39;style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-r&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="s1">&#39;stx&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="s1">&#39;uniax-x&#39;</span>
            <span class="k">return</span>
        <span class="k">def</span> <span class="nf">calc_sty</span><span class="p">():</span>
            <span class="n">u2</span> <span class="o">=</span> <span class="n">eps</span><span class="o">*</span><span class="n">size</span>
            <span class="n">calc_strength</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">,</span> <span class="s1">&#39;sty&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="s1">&#39;sty&#39;</span><span class="p">][</span><span class="s1">&#39;style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-b&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="s1">&#39;sty&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="s1">&#39;uniax-y&#39;</span>
            <span class="k">return</span>
        <span class="k">def</span> <span class="nf">calc_et2</span><span class="p">():</span>
            <span class="n">u1</span> <span class="o">=</span> <span class="mf">0.4</span><span class="o">*</span><span class="n">eps</span><span class="o">*</span><span class="n">size</span>
            <span class="n">u2</span> <span class="o">=</span> <span class="mf">0.4</span><span class="o">*</span><span class="n">eps</span><span class="o">*</span><span class="n">size</span>
            <span class="n">calc_strength</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">,</span> <span class="s1">&#39;et2&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="s1">&#39;et2&#39;</span><span class="p">][</span><span class="s1">&#39;style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-k&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="s1">&#39;et2&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="s1">&#39;equibiax&#39;</span>
            <span class="k">return</span>
        <span class="k">def</span> <span class="nf">calc_ect</span><span class="p">():</span>
            <span class="n">u1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.8</span><span class="o">*</span><span class="n">eps</span><span class="o">*</span><span class="n">size</span>
            <span class="n">u2</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">eps</span><span class="o">*</span><span class="n">size</span>
            <span class="n">calc_strength</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">,</span> <span class="s1">&#39;ect&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="s1">&#39;ect&#39;</span><span class="p">][</span><span class="s1">&#39;style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-m&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="s1">&#39;ect&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="s1">&#39;shear&#39;</span>
            <span class="k">return</span>
        
        <span class="c1">#calculate strength and stress strain data along given load paths</span>
        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">load_cases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span><span class="o">==</span><span class="s1">&#39;stx&#39;</span><span class="p">:</span> 
                <span class="n">calc_stx</span><span class="p">()</span>   <span class="c1"># uniaxial tensile yield stress in horizontal (x-)direction</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="s1">&#39;sty&#39;</span><span class="p">:</span>
                <span class="n">calc_sty</span><span class="p">()</span>   <span class="c1"># uniaxial tensile yield stress in vertical (y-)direction</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="s1">&#39;et2&#39;</span><span class="p">:</span>
                <span class="n">calc_et2</span><span class="p">()</span>   <span class="c1"># plane stress, equibiaxial strain in x and y direction</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="s1">&#39;ect&#39;</span><span class="p">:</span>
                <span class="n">calc_ect</span><span class="p">()</span>    <span class="c1"># pure shear strain (x-compression, y-tension), plane stress</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;calc_properties: Load case not supported: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case</span><span class="p">))</span></div>

<div class="viewcode-block" id="Material.plot_stress_strain"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.plot_stress_strain">[docs]</a>    <span class="k">def</span> <span class="nf">plot_stress_strain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Hill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Plot stress-strain data and print values for strength.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Hill : Boolean</span>
<span class="sd">            Decide if data for Hill-type equivalent stress is presented (optional, default: False)</span>
<span class="sd">        file : str</span>
<span class="sd">            Filename to save plot (optional)</span>
<span class="sd">        fontsize : int</span>
<span class="sd">            Fontsize for axis annotations (optional, default: 14)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">propJ2</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;ys&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;J2 yield stress under&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span><span class="s1">&#39;loading:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">propJ2</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;ys&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span><span class="s1">&#39;MPa&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propJ2</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;eeq&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">propJ2</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;seq&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;style&#39;</span><span class="p">])</span>
                <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Material: &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\epsilon_\mathrm</span><span class="si">{eq}</span><span class="s1">$ (%)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma^\mathrm</span><span class="si">{J2}</span><span class="s1">_\mathrm</span><span class="si">{eq}</span><span class="s1">$ (MPa)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file</span><span class="o">+</span><span class="s1">&#39;J2.pdf&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">Hill</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;ys&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hill yield stress under&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span><span class="s1">&#39;loading:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;ys&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span><span class="s1">&#39;MPa&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;eeq&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;seq&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;style&#39;</span><span class="p">])</span>
                    <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Material: &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\epsilon_\mathrm</span><span class="si">{eq}</span><span class="s1">$ (%)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma_\mathrm</span><span class="si">{eq}</span><span class="s1">$ (MPa)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file</span><span class="o">+</span><span class="s1">&#39;Hill.pdf&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span></div>
    
<div class="viewcode-block" id="Material.polar_plot_yl"><a class="viewcode-back" href="../../pyLabFEA.html#pylabfea.material.Material.polar_plot_yl">[docs]</a>    <span class="k">def</span> <span class="nf">polar_plot_yl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Na</span><span class="o">=</span><span class="mi">72</span><span class="p">,</span> <span class="n">cmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dname</span><span class="o">=</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">scaling</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                      <span class="n">field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">Np</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">seq_j2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Plot yield locus as polar plot in deviatoric stress plane</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Na : int</span>
<span class="sd">            Number of angles on which yield locus is evaluated (optional, default: 72)</span>
<span class="sd">        cmat : list of materials</span>
<span class="sd">            Materials of which YL is plotted in same plot with same scaling (optional)</span>
<span class="sd">        data : (N,3) array</span>
<span class="sd">            Array of cylindrical stress added to plot (optional)</span>
<span class="sd">        dname : str</span>
<span class="sd">            Label for data (optional, default: reference)</span>
<span class="sd">        scaling : float</span>
<span class="sd">            Scaling factor for stresses (optional)</span>
<span class="sd">        field : Boolean</span>
<span class="sd">            Field of decision function is plotted, works only together with ML yield function</span>
<span class="sd">            (optional, default: False)</span>
<span class="sd">        predict : Boolean</span>
<span class="sd">            Plot ML prediction (-1,1), otherwise decision fucntion is plotted (optional, default: False)</span>
<span class="sd">        Np      : int</span>
<span class="sd">            Number of points per axis for field plot (optional, default: 100)</span>
<span class="sd">        cbar    : Boolean</span>
<span class="sd">            Plot colorbar for field (optional, default: False)</span>
<span class="sd">        file  : str</span>
<span class="sd">            Name of PDF file to which plot is saved</span>
<span class="sd">        arrow : Boolean</span>
<span class="sd">            Indicate if arrows for the pricipal stress directions are shown (optional, default: False)</span>
<span class="sd">        seq_j2   : Boolean</span>
<span class="sd">            Indicate that J2 equivalent stress shall be used instead of material definition of </span>
<span class="sd">            equivalent stress (optional, default: False)</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">scaling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">scaling</span>
        <span class="n">fig</span>  <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,],</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML_yf</span><span class="p">:</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">Np</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">Np</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndof</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Np</span><span class="o">*</span><span class="n">Np</span><span class="p">)</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">hh</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;polar_plot_yl&quot; currently does not support texture as degree of freedom for field plots.&#39;</span><span class="p">)</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;PuOr_r&#39;</span><span class="p">)</span>  <span class="c1">#&#39;bwr&#39; and &#39;PuOr_r&#39; are good choices</span>
            <span class="k">if</span> <span class="n">predict</span><span class="p">:</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svm_yf</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
            <span class="s1">&#39;symmetrize Z values&#39;</span>
            <span class="n">zmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">zmin</span> <span class="o">&lt;</span> <span class="n">zmax</span><span class="p">):</span>
                <span class="n">Z</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Z</span><span class="o">&gt;-</span><span class="n">zmin</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">zmin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Z</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Z</span><span class="o">&lt;-</span><span class="n">zmax</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">zmax</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,(</span><span class="n">yy</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_seq</span><span class="o">*</span><span class="n">sf</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> 
                               <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cbar</span><span class="p">:</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;yield function (MPa)&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>
        <span class="c1">#find norm of princ. stess vector lying on yield surface</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">Na</span><span class="p">)</span>
        <span class="n">snorm</span> <span class="o">=</span> <span class="n">sig_cyl2princ</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Na</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">theta</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find_yloc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Na</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="n">snorm</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">snorm</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">seq_j2</span><span class="p">:</span>
            <span class="n">s_yld</span> <span class="o">=</span> <span class="n">sig_eq_j2</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s_yld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_seq</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">s_yld</span><span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmat</span><span class="p">)</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;copper&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmat</span><span class="p">):</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">find_yloc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Na</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="n">snorm</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">)</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">snorm</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                <span class="k">if</span> <span class="n">seq_j2</span><span class="p">:</span>
                    <span class="n">s_yld</span> <span class="o">=</span> <span class="n">sig_eq_j2</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s_yld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_seq</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">s_yld</span><span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">N</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">mat</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sf</span><span class="p">,</span><span class="s1">&#39;.b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">dname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arrow</span><span class="p">:</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy</span>
            <span class="n">drh</span> <span class="o">=</span> <span class="mf">0.08</span><span class="o">*</span><span class="n">dr</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> 
                     <span class="n">head_length</span><span class="o">=</span><span class="n">drh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">dr</span><span class="o">*</span><span class="mf">0.89</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_1$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mf">2.0944</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                     <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="n">drh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2.24</span><span class="p">,</span> <span class="n">dr</span><span class="o">*</span><span class="mf">0.94</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_2$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0944</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                     <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="n">drh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">2.04</span><span class="p">,</span> <span class="n">dr</span><span class="o">*</span><span class="mf">0.97</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_3$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">.9</span><span class="p">,</span><span class="mf">0.95</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">.9</span><span class="p">,</span><span class="mf">0.95</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ax</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pyLabFEA 4.1.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pylabfea.material</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, 2021, 2022, Alexander Hartmaier, ICAMS/Ruhr University Bochum, Germany.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>data &#8212; pyLabFEA 2.0.53 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for data</h1><div class="highlight"><pre>
<span></span><span class="c1">#Module pylabfea.data</span>
<span class="sd">&#39;&#39;&#39;Module pylabfea.data introduces the class ``Data`` for handling of data resulting </span>
<span class="sd">from virtual or physical mechanical tests in the pyLabFEA package. This class provides the </span>
<span class="sd">methods necessary for analyzing data. During this processing, all information is gathered </span>
<span class="sd">that is required to define a material, i.e., all parameters for elasticity, plasticity, </span>
<span class="sd">and microstructures are provided from the data. Materials are defined in </span>
<span class="sd">module pylabfea.material based on the analyzed data of this module.</span>

<span class="sd">uses NumPy, SciPy, MatPlotLib, Pandas</span>

<span class="sd">Version: 3.4 (2021-04-07)</span>
<span class="sd">Author: Alexander Hartmaier, ICAMS/Ruhr-University Bochum, April 2020</span>
<span class="sd">Email: alexander.hartmaier@rub.de</span>
<span class="sd">distributed under GNU General Public License (GPLv3)&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">pylabfea.basic</span> <span class="kn">import</span> <span class="n">Stress</span><span class="p">,</span> <span class="n">eps_eq</span><span class="p">,</span> <span class="n">polar_ang</span><span class="p">,</span> <span class="n">s_cyl</span><span class="p">,</span> \
                           <span class="n">seq_J2</span><span class="p">,</span> <span class="n">sp_cart</span><span class="p">,</span> <span class="n">svoigt</span>
<span class="c1">#from pylabfea.model import Model</span>
<span class="c1">#from pylabfea.material import Material</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">fireworks</span> <span class="kn">import</span> <span class="n">LaunchPad</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="n">sig_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;S11&#39;</span><span class="p">,</span><span class="s1">&#39;S22&#39;</span><span class="p">,</span><span class="s1">&#39;S33&#39;</span><span class="p">,</span><span class="s1">&#39;S23&#39;</span><span class="p">,</span><span class="s1">&#39;S13&#39;</span><span class="p">,</span><span class="s1">&#39;S12&#39;</span><span class="p">]</span>
<span class="n">theta_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span>
<span class="n">epl_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ep11&#39;</span><span class="p">,</span><span class="s1">&#39;Ep22&#39;</span><span class="p">,</span><span class="s1">&#39;Ep33&#39;</span><span class="p">,</span><span class="s1">&#39;Ep23&#39;</span><span class="p">,</span><span class="s1">&#39;Ep13&#39;</span><span class="p">,</span><span class="s1">&#39;Ep12&#39;</span><span class="p">]</span>
<span class="n">eps_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E11&#39;</span><span class="p">,</span><span class="s1">&#39;E22&#39;</span><span class="p">,</span><span class="s1">&#39;E33&#39;</span><span class="p">,</span><span class="s1">&#39;E23&#39;</span><span class="p">,</span><span class="s1">&#39;E13&#39;</span><span class="p">,</span><span class="s1">&#39;E12&#39;</span><span class="p">]</span>
<span class="n">eel_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ee11&#39;</span><span class="p">,</span><span class="s1">&#39;Ee22&#39;</span><span class="p">,</span><span class="s1">&#39;Ee33&#39;</span><span class="p">,</span><span class="s1">&#39;Ee23&#39;</span><span class="p">,</span><span class="s1">&#39;Ee13&#39;</span><span class="p">,</span><span class="s1">&#39;Ee12&#39;</span><span class="p">]</span>
<span class="n">ebc_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;StrainX&#39;</span><span class="p">,</span> <span class="s1">&#39;StrainY&#39;</span><span class="p">,</span> <span class="s1">&#39;StrainZ&#39;</span><span class="p">,</span> <span class="s1">&#39;StrainYZ&#39;</span><span class="p">,</span><span class="s1">&#39;StrainXZ&#39;</span><span class="p">,</span><span class="s1">&#39;StrainXY&#39;</span><span class="p">]</span>
<span class="n">sbc_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;StressX&#39;</span><span class="p">,</span><span class="s1">&#39;StressY&#39;</span><span class="p">,</span><span class="s1">&#39;StressZ&#39;</span><span class="p">,</span><span class="s1">&#39;StressYZ&#39;</span><span class="p">,</span><span class="s1">&#39;StressXZ&#39;</span><span class="p">,</span><span class="s1">&#39;StressXY&#39;</span><span class="p">]</span>
<span class="n">ubc_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ux&#39;</span><span class="p">,</span> <span class="s1">&#39;uy&#39;</span><span class="p">,</span> <span class="s1">&#39;uz&#39;</span><span class="p">]</span>
<span class="n">fbc_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fx&#39;</span><span class="p">,</span> <span class="s1">&#39;fy&#39;</span><span class="p">,</span> <span class="s1">&#39;fz&#39;</span><span class="p">]</span>
            
<span class="c1">#=================</span>
<span class="c1">#define data class</span>
<span class="c1">#=================</span>
<div class="viewcode-block" id="Data"><a class="viewcode-back" href="../pyLabFEA.html#data.Data">[docs]</a><span class="k">class</span> <span class="nc">Data</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Define class for handling data from virtual mechanical tests in micromechanical </span>
<span class="sd">    simulations and data from physical mechanical tests on materials with various </span>
<span class="sd">    microstructures</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msl  : list</span>
<span class="sd">        List with names of JOSN files with metadata for all microstructures</span>
<span class="sd">    path_data : str</span>
<span class="sd">        Trunc of pathname for data files</span>
<span class="sd">    path_json : str</span>
<span class="sd">        Trunc of pathname for JSON metadata files (optional, default: path_data)</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of Dataset (optional, default: &#39;Dataset&#39;)</span>
<span class="sd">    sdim : int</span>
<span class="sd">        Dimensionality of stresses; if sdim=3 only principal stresses are considered (optional, default: 3)</span>
<span class="sd">    mirror : Boolean</span>
<span class="sd">        Indicate if stresses shall be doubled by periodic completion of cylindrical stresses</span>
<span class="sd">        on the deviatoric plane of the principal stress space (optional, default: False)</span>
<span class="sd">    nth  : int</span>
<span class="sd">        Read only every nth lines of input file (optional, default: 1)</span>
<span class="sd">    epl_crit : float</span>
<span class="sd">        Critical plastic strain at which yield strength is defined (optional, default: 2.e-3)</span>
<span class="sd">    d_ep     : float</span>
<span class="sd">        Range around critical value of plastic strain in which flow stresses are</span>
<span class="sd">        evaluated (optional, default: 5.e-4)</span>
<span class="sd">    npe : int</span>
<span class="sd">        Number of equiv. plastic strains used for work hardening</span>
<span class="sd">        </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    msl   : list</span>
<span class="sd">    Nset  : int</span>
<span class="sd">    name  : str</span>
<span class="sd">    pd    : str</span>
<span class="sd">    pj    : str</span>
<span class="sd">    epc   : float</span>
<span class="sd">    dep   : float</span>
<span class="sd">    set   : list</span>
<span class="sd">    sy_av : float</span>
<span class="sd">    E_av  : float</span>
<span class="sd">    nu_av : float</span>
<span class="sd">    flow_stress : Boolean</span>
<span class="sd">    mat_param : dictionary</span>
<span class="sd">        Contains available data for microstructural parameters (&quot;texture&quot;, &quot;work_hard&quot;, </span>
<span class="sd">       &quot;flow_stress&quot;) to be transfered to material.microstructure</span>
<span class="sd">        flow_stress : (N,6)-array</span>
<span class="sd">        Stress-strain data (Voigt stress tensors at each PEEQ in &quot;work_hard&quot;)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msl</span><span class="p">,</span> <span class="n">path_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path_json</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">17000</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dataset&#39;</span><span class="p">,</span> <span class="n">sdim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mirror</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">epl_crit</span><span class="o">=</span><span class="mf">2.e-3</span><span class="p">,</span> <span class="n">d_ep</span><span class="o">=</span><span class="mf">5.e-4</span><span class="p">,</span> <span class="n">epl_max</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">npe</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        
        <span class="k">def</span> <span class="nf">calc_grid_val</span><span class="p">():</span>
            <span class="c1">#for each load case in each set: interpolate flow stress to fixed PEEQ grid</span>
            <span class="n">Nlc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="s1">&#39;Nlc&#39;</span><span class="p">]</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">,</span><span class="n">npe</span><span class="p">,</span><span class="n">Nlc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">))</span>
            <span class="n">sflow_av</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">,</span><span class="n">npe</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">iset</span><span class="p">,</span> <span class="n">dset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">):</span>   <span class="c1"># loop over data sets</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                    <span class="c1">#data for stress tensor at yield onset provided in data</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">sf</span><span class="p">[</span><span class="n">iset</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">syc</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sf</span><span class="p">[</span><span class="n">iset</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">sig</span>
                    <span class="n">sflow_av</span><span class="p">[</span><span class="n">iset</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>    <span class="c1"># average seq over polar angles</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">mirror</span> <span class="k">else</span> <span class="mi">1</span>
                    <span class="n">N0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Nlc</span><span class="o">/</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">N1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">load_case</span><span class="p">)</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">N0</span><span class="p">)</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">N1</span><span class="p">)</span>
                    <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">N1</span><span class="p">)</span>
                    <span class="n">ilc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                
                    <span class="k">for</span> <span class="n">ipeeq</span><span class="p">,</span> <span class="n">peeq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="s1">&#39;work_hard&#39;</span><span class="p">]):</span>  <span class="c1"># loop over PEEQS for which flow stresses are required</span>
                        <span class="n">hs</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">ht</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N0</span><span class="p">):</span>  <span class="c1"># loop over load cases for each level of PEEQ</span>
                            <span class="c1">#this should be generalized for the case that Nlc varies strongly over the sets</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">load_case</span><span class="p">[</span><span class="n">ilc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>  <span class="c1"># indices of data points belonging to this load case</span>
                            <span class="c1">#select data points above and below peeq</span>
                            <span class="n">iel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">peeq_full</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&lt;</span><span class="n">peeq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># find elastic data sets in load case</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iel</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">iel</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">ipl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">peeq_full</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">peeq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># find plastic data sets in load case</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ipl</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">ipl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">eel</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">peeq_full</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>  <span class="c1"># last data point &lt; peeq</span>
                            <span class="n">epl</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">peeq_full</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ipl</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>   <span class="c1"># first data point &gt; peeq</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                                <span class="n">s0</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># largest flow stress below peeq</span>
                                <span class="n">s1</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ipl</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># smallest flow stress above peeq</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">s0</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],:]</span>  <span class="c1"># largest flow stress below peeq</span>
                                <span class="n">s1</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ipl</span><span class="p">[</span><span class="mi">0</span><span class="p">]],:]</span>   <span class="c1"># smallest flow stress above peeq</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">-</span> <span class="n">s0</span>     <span class="c1"># difference in seq b/w data points around peeq</span>
                            <span class="n">de</span> <span class="o">=</span> <span class="n">epl</span> <span class="o">-</span> <span class="n">eel</span>  <span class="c1"># difference in peeq for closest data points</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">de</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1.e-6</span><span class="p">:</span>
                                <span class="n">sint</span><span class="o">=</span><span class="n">s0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sint</span> <span class="o">=</span> <span class="n">s0</span> <span class="o">+</span> <span class="p">(</span><span class="n">peeq</span><span class="o">-</span><span class="n">eel</span><span class="p">)</span><span class="o">*</span><span class="n">ds</span><span class="o">/</span><span class="n">de</span> <span class="c1"># linearly interpolated equiv. flow stress at peeq</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                                <span class="n">theta</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># polar angle (not interpolated)</span>
                                <span class="n">hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sint</span><span class="p">)</span>  <span class="c1"># append interpolated equiv. flow stress</span>
                                <span class="n">ht</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="c1"># append original polar angle of load case</span>
                                <span class="k">if</span> <span class="n">mirror</span><span class="p">:</span>
                                    <span class="n">hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sint</span><span class="p">)</span> <span class="c1"># append twice to consider tension compression symmetry in material</span>
                                    <span class="n">theta</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># mirror polar angle</span>
                                    <span class="k">if</span> <span class="n">theta</span><span class="o">&lt;-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                                        <span class="n">theta</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                                    <span class="n">ht</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="c1"># append mirrored polar angles</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sint</span><span class="p">)</span> <span class="c1"># append interpolated flow stress at PEEQ</span>
                                <span class="k">if</span> <span class="n">mirror</span><span class="p">:</span>
                                    <span class="n">hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">sint</span><span class="p">)</span> <span class="c1"># append mirrored flow stress values</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span> <span class="c1"># sort w.r.t. polar angle</span>
                        <span class="n">ie</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hs</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span> <span class="c1"># sort w.r.t. polar angle</span>
                            <span class="n">sf</span><span class="p">[</span><span class="n">iset</span><span class="p">,</span><span class="n">ipeeq</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hs</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>   <span class="c1"># first component: seq</span>
                            <span class="n">sf</span><span class="p">[</span><span class="n">iset</span><span class="p">,</span><span class="n">ipeeq</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ht</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>   <span class="c1"># second component: polar angle</span>
                            <span class="n">sflow_av</span><span class="p">[</span><span class="n">iset</span><span class="p">,</span><span class="n">ipeeq</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">hs</span><span class="p">)</span>    <span class="c1"># average seq over polar angles</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hs</span><span class="p">)</span>
                            <span class="n">sf</span><span class="p">[</span><span class="n">iset</span><span class="p">,</span><span class="n">ipeeq</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">ie</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ht</span> <span class="c1"># store flow stresses for texture and PEEQ</span>
                            <span class="n">sflow_av</span><span class="p">[</span><span class="n">iset</span><span class="p">,</span><span class="n">ipeeq</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">seq_J2</span><span class="p">(</span><span class="n">ht</span><span class="p">))</span> <span class="c1"># calculate average equiv. flow stress  </span>
            <span class="k">return</span> <span class="n">sf</span><span class="p">,</span> <span class="n">sflow_av</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">sdim</span><span class="o">!=</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">sdim</span><span class="o">!=</span><span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value of sdim must be either 3 or 6&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span> <span class="o">=</span> <span class="n">sdim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span> <span class="o">=</span> <span class="n">mirror</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nth</span> <span class="o">=</span> <span class="n">nth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epc</span> <span class="o">=</span> <span class="n">epl_crit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dep</span> <span class="o">=</span> <span class="n">d_ep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow_stress</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predef</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#import and pre-process data of all microstructure</span>
        <span class="k">if</span> <span class="n">path_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pd</span> <span class="o">=</span> <span class="n">path_data</span>
            <span class="k">if</span> <span class="n">path_json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pj</span> <span class="o">=</span> <span class="n">path_json</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd</span>
            <span class="c1"># data is read as CSV from given path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msl</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">msl</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Set_CSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># data is read from mongo database on server</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">username</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pw</span>   <span class="o">=</span> <span class="n">password</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msl</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">msl</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Set_DB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#data is read from given data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Set_Data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msl</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="c1">#calculate average properties over all microstructures</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">micr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">peeq_min</span> <span class="o">=</span> <span class="n">epl_max</span>  <span class="c1"># minimum final equiv. plastic strain reached in sets</span>
        <span class="n">Nlc_min</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># minimum number of load cases reached in sets</span>
        <span class="n">ttyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">texture_type</span>
        <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dset</span><span class="o">.</span><span class="n">sy</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">nu</span><span class="p">])</span>
            <span class="n">micr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">texture_param</span><span class="p">)</span>
            <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">texture_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                <span class="n">peeq_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">peeq_min</span><span class="p">,</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">peeq_full</span><span class="p">))</span> <span class="c1">#dset.peeq_full[-10])</span>
                <span class="n">Nlc_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">Nlc_min</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">Nlc</span><span class="p">)</span>
                <span class="c1">#Nlc_min = np.minimum(Nlc_min, i*len(dset.load_case))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">peeq_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epc</span>
                <span class="n">Nlc_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">Nlc_min</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">Nlc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dset</span><span class="o">.</span><span class="n">texture_type</span><span class="o">!=</span><span class="n">ttyp</span> <span class="ow">and</span> <span class="n">dset</span><span class="o">.</span><span class="n">texture_type</span><span class="o">!=</span><span class="s1">&#39;Random&#39;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Warning: Different texture types mixed in data set &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">prop</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span>  <span class="c1"># average properties over all microstructures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sy_av</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># information needed when material.plasticity is initiated </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E_av</span>  <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># information needed when material.elasticity is initiated </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nu_av</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">###   Data set &quot;</span><span class="si">%s</span><span class="s1">&quot;  ###&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Type of microstructure: &#39;</span><span class="p">,</span> <span class="n">ttyp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Imported </span><span class="si">%i</span><span class="s1"> data sets for textures, with </span><span class="si">%i</span><span class="s1"> hardening stages and </span><span class="si">%i</span><span class="s1"> load cases each.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="n">Nlc_min</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Averaged properties : E_av=</span><span class="si">%5.2f</span><span class="s1"> GPa, nu_av=</span><span class="si">%4.2f</span><span class="s1">, sy_av=</span><span class="si">%4.2f</span><span class="s1"> MPa&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E_av</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_av</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy_av</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span> <span class="o">=</span> <span class="p">{</span>      <span class="c1"># this information of the data will be copied into the material upon definition of its microstructure</span>
            <span class="s1">&#39;ms_type&#39;</span>     <span class="p">:</span> <span class="n">ttyp</span><span class="p">,</span>      <span class="c1"># unimodal texture type</span>
            <span class="s1">&#39;sdim&#39;</span>        <span class="p">:</span> <span class="n">sdim</span><span class="p">,</span>      <span class="c1"># dimnesionaltiy of stress values in data (3: only princ. stresses, 6: full stresses)</span>
            <span class="s1">&#39;Npl&#39;</span>         <span class="p">:</span> <span class="n">npe</span><span class="p">,</span>       <span class="c1"># number of PEEQ values </span>
            <span class="s1">&#39;Nlc&#39;</span>         <span class="p">:</span> <span class="n">Nlc_min</span><span class="p">,</span>   <span class="c1"># number of load cases covered in data (minimum of load cases reached over all sets)</span>
            <span class="s1">&#39;Ntext&#39;</span>       <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">,</span> <span class="c1"># number of microstructures covered by sets</span>
            <span class="s1">&#39;texture&#39;</span>     <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">micr</span><span class="p">),</span>  <span class="c1"># texture parameter: mixture parameter ms_type wrt random</span>
            <span class="s1">&#39;tx_name&#39;</span>     <span class="p">:</span> <span class="n">name</span><span class="p">,</span>      <span class="c1"># list of names of different textures</span>
            <span class="s1">&#39;peeq_max&#39;</span>    <span class="p">:</span> <span class="n">peeq_min</span><span class="p">,</span>  <span class="c1"># maximum PEEQ covered in data (must be minimum of value reached over all sets)</span>
            <span class="s1">&#39;epc&#39;</span>         <span class="p">:</span> <span class="n">epl_crit</span><span class="p">,</span>  <span class="c1"># critical PEEQ for with yield stress is defined </span>
            <span class="s1">&#39;work_hard&#39;</span>   <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">epl_crit</span><span class="p">,</span><span class="n">peeq_min</span><span class="p">,</span><span class="n">npe</span><span class="p">),</span> <span class="c1"># values of PEEQ for which flow stresses are available</span>
            <span class="s1">&#39;E_av&#39;</span>        <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_av</span><span class="p">,</span> <span class="c1"># Young&#39;s modulus</span>
            <span class="s1">&#39;nu_av&#39;</span>       <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_av</span><span class="p">,</span><span class="c1"># Poisson ratio</span>
            <span class="s1">&#39;sy_av&#39;</span>       <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy_av</span> <span class="c1"># yield strength</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">)</span>
        <span class="n">syld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="p">,</span><span class="n">Nlc_min</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>  <span class="c1"># Voigt stress tensor at onset of yielding</span>
        <span class="k">for</span> <span class="n">iset</span><span class="p">,</span> <span class="n">dset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">):</span>   <span class="c1"># loop over data sets</span>
            <span class="n">syld</span><span class="p">[</span><span class="n">iset</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">syld</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nlc_min</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="s1">&#39;sig_yld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">syld</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nset</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">npe</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sf</span><span class="p">,</span> <span class="n">sflow_av</span> <span class="o">=</span> <span class="n">calc_grid_val</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sflow_av</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sy</span><span class="p">]])</span> <span class="c1"># average flow stress</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Nlc_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="p">))</span>
            <span class="n">sf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">syld</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nlc_min</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="s1">&#39;flow_stress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf</span>       <span class="c1">#  flow stresses at PEEQs in &#39;work_hard&#39; for each texture</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="s1">&#39;flow_seq_av&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sflow_av</span> <span class="c1"># averaged equiv. flow stresses at PEEQs in &#39;work_hard&#39; for each texture</span>
 
<div class="viewcode-block" id="Data.Set_CSV"><a class="viewcode-back" href="../pyLabFEA.html#data.Data.Set_CSV">[docs]</a>    <span class="k">class</span> <span class="nc">Set_CSV</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Define class for handling of aCSV dataset for one individual material. At </span>
<span class="sd">        least stress data must be provided in dataset. Strain data must be provided </span>
<span class="sd">        for class &quot;Flow_Stress&quot;, if only total strain is given, plastic strain is </span>
<span class="sd">        assumed to be equal to total strain.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db   : object of type ``Data``</span>
<span class="sd">            Parent database from which properties are inherited</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of JSON file with metadata for microstructure to be stored in this dataset</span>
<span class="sd">        plot : Boolean</span>
<span class="sd">            Graphical output of data in each set (optional, default: False)</span>
<span class="sd">        </span>
<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        db : object of class ``Data``</span>
<span class="sd">        name : str</span>
<span class="sd">        N  : int</span>
<span class="sd">            Number of imported data points</span>
<span class="sd">        Ndat : int</span>
<span class="sd">            Number of raw data points (filtered data lying around yield point mirrored wrt polar angle)</span>
<span class="sd">        Nlc  : int</span>
<span class="sd">            Number of load cases in raw data</span>
<span class="sd">        E, nu : float</span>
<span class="sd">            Elastic parameters obtained from data</span>
<span class="sd">        sy    : float</span>
<span class="sd">            Yield strength obtained from data</span>
<span class="sd">        texture_param : float</span>
<span class="sd">            Microstructure parameter for texture</span>
<span class="sd">        eps, epl, eel, sig, ubc, sc_full : (N,) array</span>
<span class="sd">        sfc_   : (Ndat,3) array</span>
<span class="sd">            Filtered cyl. stress tensor around yield point</span>
<span class="sd">        peeq_  : (Ndat,) array</span>
<span class="sd">            Filtered equiv. plastic strain around yield point</span>
<span class="sd">        ubc_   : (Ndat,db.sdim) array</span>
<span class="sd">            Filtered boundary condition vector around yield point</span>
<span class="sd">        sig_   : (Ndat,db.sdim) array</span>
<span class="sd">            Filtered stress tensor around yield point (princ. stresses for sdim=3)</span>
<span class="sd">        f_yld_ : (Ndat,) array</span>
<span class="sd">            Categorial yield function of data points around yield point (&quot;-1&quot;: elastic, &quot;+1&quot;: plastic)</span>
<span class="sd">        i_el_  : (Ndat,) array</span>
<span class="sd">            Filtered indeces of data points lying in elastic regime</span>
<span class="sd">        i_pl_  : (Ndat,) array</span>
<span class="sd">            Filtered indeces for data points lying in plastic regime</span>
<span class="sd">        syc    : (Nlc,3) array</span>
<span class="sd">            Yield strength: interpolated cyl. stress tensor at onset of yielding for individual load cases</span>
<span class="sd">        load_case : list</span>
<span class="sd">            List of lists with data set indices belonging to one single load case from full data </span>
<span class="sd">            (index space: [0,N])</span>
<span class="sd">        lc_    : list</span>
<span class="sd">            List of lists with data set indices belonging to one single load case from filtered data </span>
<span class="sd">            around yield point (index space: [0,Ndat])</span>
<span class="sd">    </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;def prop_elastic():</span>
<span class="sd">                &#39;calculate estimates for elastic properties E, nu associated to data set&#39;</span>
<span class="sd">                ssig = 1.e-1</span>
<span class="sd">                seps = 1.e3</span>
<span class="sd">                a = seps*self.eps[ind,:]</span>
<span class="sd">                b = ssig*self.sig[ind,:]</span>
<span class="sd">                x = np.linalg.lstsq(a, b, rcond=None)</span>
<span class="sd">                c = x[0]*seps/ssig</span>
<span class="sd">                self.C11 = c[0,0]</span>
<span class="sd">                self.C12 = c[1,0]</span>
<span class="sd">                self.C13 = c[2,0]</span>
<span class="sd">                self.C21 = c[0,1]</span>
<span class="sd">                self.C22 = c[1,1]</span>
<span class="sd">                self.C23 = c[2,1]</span>
<span class="sd">                self.C31 = c[0,2]</span>
<span class="sd">                self.C32 = c[1,2]</span>
<span class="sd">                self.C33 = c[2,2]</span>
<span class="sd">                </span>
<span class="sd">                #self.nu = self.C12/(self.C11 + self.C12) # estimate for isotropic materials</span>
<span class="sd">                #self.E = self.C12*(1.+self.nu)*(1.-2.*self.nu)/self.nu</span>
<span class="sd">                </span>
<span class="sd">                print(&#39;Estimated elasic tensor C_ij (GPa): \n%8.2f, %8.2f, %8.2f&#39; </span>
<span class="sd">                       % (self.C11/1000, self.C12/1000, self.C13/1000))</span>
<span class="sd">                print(&#39;%8.2f, %8.2f, %8.2f&#39; </span>
<span class="sd">                       % (self.C21/1000, self.C22/1000, self.C23/1000))</span>
<span class="sd">                print(&#39;%8.2f, %8.2f, %8.2f&#39; </span>
<span class="sd">                       % (self.C31/1000, self.C32/1000, self.C33/1000))</span>
<span class="sd">                print(&#39;Residuals of fitting elastic parameters: &#39;,x[1])&#39;&#39;&#39;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
            <span class="n">eps_0</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">sig_0</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">epl_0</span> <span class="o">=</span> <span class="mf">0.</span>
            
            <span class="c1">#import metadata from json file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">pj</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">sep</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CSV_separator&#39;</span><span class="p">]</span>
            <span class="n">file</span>  <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">pd</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CSV_data&#39;</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CSV_format&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">hh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CSV_header&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">hh</span><span class="o">==</span><span class="s1">&#39;None&#39;</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No header specified in meta data, assuming a header line exists&#39;</span><span class="p">)</span>
                <span class="n">header</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;Flow_Stress&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Incompatible data sets: Yield_Stress and Flow-Stress classes cannot be mixed.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;Yield_Stress&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Incompatible data sets: Yield_Stress and Flow-Stress classes cannot be mixed.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;Predeformed&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">predef</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Incompatible data sets: Yield_Stress and Flow-Stress classes cannot be mixed.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown value for Class: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
                
            <span class="c1">#import texture parameters from json file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">texture_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;Texture_index&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">texture_name</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;Texture_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">texture_type</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;Texture_type&#39;</span><span class="p">]</span>
            
            <span class="c1"># read dataset from CSV file</span>
            <span class="n">AllData</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
            
            <span class="c1"># analyze data and store as internal variables</span>
            <span class="c1"># stress data must be provided</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">AllData</span><span class="p">[</span><span class="n">sig_names</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[::</span><span class="n">db</span><span class="o">.</span><span class="n">nth</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                <span class="c1">#flow stresses are privided for various strains</span>
                <span class="c1">#totl strain must be provided in data set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">AllData</span><span class="p">[</span><span class="n">eps_names</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[::</span><span class="n">db</span><span class="o">.</span><span class="n">nth</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">epl_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="c1">#read plastic strain if contained</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epl</span> <span class="o">=</span> <span class="n">AllData</span><span class="p">[</span><span class="n">epl_names</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[::</span><span class="n">db</span><span class="o">.</span><span class="n">nth</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#if no plastic strains are contained in data set</span>
                    <span class="c1">#plastic strain is assumed to equal total strain</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epl</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">eel_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eel</span> <span class="o">=</span> <span class="n">AllData</span><span class="p">[</span><span class="n">eel_names</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[::</span><span class="n">db</span><span class="o">.</span><span class="n">nth</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">theta_name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>  
                    <span class="bp">self</span><span class="o">.</span><span class="n">theta</span>   <span class="o">=</span> <span class="n">AllData</span><span class="p">[</span><span class="n">theta_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[::</span><span class="n">db</span><span class="o">.</span><span class="n">nth</span><span class="p">]</span>
                    
                <span class="c1"># get information about load cases (boundary conditions)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ubc_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">AllData</span><span class="p">[</span><span class="n">ubc_names</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[::</span><span class="n">db</span><span class="o">.</span><span class="n">nth</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">ebc_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span> <span class="o">=</span> <span class="n">AllData</span><span class="p">[</span><span class="n">ebc_names</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[::</span><span class="n">db</span><span class="o">.</span><span class="n">nth</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">fbc_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">AllData</span><span class="p">[</span><span class="n">fbc_names</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[::</span><span class="n">db</span><span class="o">.</span><span class="n">nth</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">sbc_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span> <span class="o">=</span> <span class="n">AllData</span><span class="p">[</span><span class="n">sbc_names</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[::</span><span class="n">db</span><span class="o">.</span><span class="n">nth</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># no data for BC found, test if information is provided in metadata</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># check if information on type of boundary conditions (BC)</span>
                        <span class="c1"># is provided in meta data, either &quot;disp&quot; for displacement</span>
                        <span class="c1"># or &quot;force&quot; for force BC</span>
                        <span class="n">lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CSV_BC_type&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">lc</span><span class="o">==</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span>
                            <span class="n">eeq</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">eeq</span><span class="o">&lt;</span><span class="mf">1.e-7</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># filter cases with small strains</span>
                            <span class="n">eeq</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="o">/</span><span class="n">eeq</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="c1"># generate information on load case from normalized strain</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># cases with small strains inherit ubc from subsequent case</span>
                        <span class="k">elif</span> <span class="n">lc</span><span class="o">==</span><span class="s1">&#39;force&#39;</span><span class="p">:</span>
                            <span class="n">seq</span> <span class="o">=</span> <span class="n">seq_J2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">seq</span><span class="o">&lt;</span><span class="mf">1.e-4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># filter cases with small stresses</span>
                            <span class="n">seq</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="o">/</span><span class="n">seq</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="c1"># generate information on load case from normalized stress</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># cases with small stress inherit ubc from subsequent case</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrong BC_type provided in file &#39;</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">pj</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.json: BC_type=&#39;</span><span class="p">,</span><span class="n">lc</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;BC_type given in meta data not supported.&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No information on load cases found. Cannot process Flow_Stress-type data&#39;</span><span class="p">)</span>
                   
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">predef</span><span class="p">:</span>
                <span class="c1"># store initial stress value for data with predeformation</span>
                <span class="n">sig_0</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#self.sig -= sig_0</span>
                
            <span class="c1">#input completed, now the postprocessing of the data starts</span>
            <span class="c1"># calculate cylindrical stresses (containing equiv. stress)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">sdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span> <span class="o">=</span> <span class="n">s_cyl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>   <span class="c1"># transform princ. stresses into cylindrical coordinates</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evec</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evec</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hsv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">):</span>
                    <span class="n">hso</span> <span class="o">=</span> <span class="n">Stress</span><span class="p">(</span><span class="n">hsv</span><span class="p">)</span>  <span class="c1"># define object of stress tensor</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">hso</span><span class="o">.</span><span class="n">cyl</span><span class="p">()</span> <span class="c1"># transform princ. stress into cylindrical stress</span>
                    <span class="c1"># store eigenvectors in form of rotation matrix from reference frame to princ. stress frame</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">evec</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span>  <span class="o">=</span> <span class="n">hso</span><span class="o">.</span><span class="n">evec</span> 
            <span class="c1"># calculate equiv. strains and correct for predeformation if applicable</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                <span class="c1"># data contains full stress-strain curves</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">predef</span><span class="p">:</span>
                    <span class="c1"># correct starting points for strains in case of pre-deformation</span>
                    <span class="n">eps_0</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">-=</span> <span class="n">eps_0</span>
                    <span class="n">epl_0</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epl</span> <span class="o">-=</span> <span class="n">epl_0</span>
                <span class="c1">#calculate eqiv. plastic strains </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">peeq_full</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epl</span><span class="p">)</span>
                
            <span class="c1">#Write essential information</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*** Microstructure:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;***&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="s1">&#39; data points imported into database &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data for flow stresses at various plastic strains imported.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">predef</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">###Mechanical data obtained after predeformation.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial stress: &#39;</span><span class="p">,</span><span class="n">sig_0</span><span class="p">,</span> <span class="s1">&#39; equiv. stress: &#39;</span><span class="p">,</span> <span class="n">seq_J2</span><span class="p">(</span><span class="n">sig_0</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial total strain: &#39;</span><span class="p">,</span><span class="n">eps_0</span><span class="p">,</span> <span class="s1">&#39;equiv. total strain&#39;</span><span class="p">,</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">eps_0</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial plastic strain: &#39;</span><span class="p">,</span><span class="n">epl_0</span><span class="p">,</span> <span class="s1">&#39;equiv. plastic strain: &#39;</span><span class="p">,</span><span class="n">eps_eq</span><span class="p">(</span><span class="n">epl_0</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial values have been subtracted from stress-strain data.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Texture &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">texture_name</span><span class="p">,</span> <span class="s1">&#39;with texture parameter: &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">texture_param</span><span class="p">)</span>
            
            <span class="c1">#Consistency checks</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="n">h1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">h2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;*** Warning: Large hydrostatic stresses: minimum p=&#39;</span><span class="o">+</span><span class="n">h1</span><span class="o">+</span><span class="s1">&#39; MPa, maximum p=&#39;</span><span class="o">+</span><span class="n">h2</span><span class="o">+</span><span class="s1">&#39; MPa&#39;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                <span class="c1">#data provided only for stress tensor at yield point</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syc</span>  <span class="o">=</span> <span class="n">s_cyl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>   <span class="c1"># critical cylindrical stress tensor at yield onset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syld</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sy</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># average value for yield strength of data set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated yield strength: </span><span class="si">%5.2f</span><span class="s1"> MPa, from </span><span class="si">%i</span><span class="s1"> data sets with PEEQ </span><span class="si">%5.3f</span><span class="s1">&#39;</span> 
                      <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="p">))</span>
                <span class="k">if</span> <span class="s2">&quot;Prop_E&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;Prop_E&#39;</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Young&#39;s modulus provided in meta data:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="s2">&quot;Prop_nu&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;Prop_nu&#39;</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Poisson ratio provided in meta data:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#data is provided for flow stress at various plastic strains</span>
                <span class="c1">#filter load cases for complete stress-strain data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_case</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list of lists with data set indices belonging to one load case</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">uvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
                <span class="n">toler</span> <span class="o">=</span> <span class="mf">1.e-2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">uvec</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">uvec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">toler</span><span class="p">:</span>
                        <span class="n">hh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span>
                        <span class="n">hh</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">uvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of load cases identified in original data:&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="p">))</span>
                
                <span class="c1">#select data points close to yield point =&gt; yield strength sy and raw data for ML flow rule</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peeq_full</span><span class="o">&gt;</span><span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="o">-</span><span class="n">db</span><span class="o">.</span><span class="n">dep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeq_full</span><span class="o">&lt;</span><span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="o">+</span><span class="n">db</span><span class="o">.</span><span class="n">dep</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;***Warning: too few data points around yield criterion:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;, &#39;</span>\
                                  <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dep</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="n">scyl_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">scyl_raw</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># get first estimate of yield point, will be refined later</span>
            
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">mirror</span><span class="p">:</span>
                    <span class="c1">#mirror stress data w.r.t. theta in deviatoric stress space</span>
                    <span class="n">peeq_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeq_full</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="n">sc2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">sc2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scyl_raw</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sc2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scyl_raw</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                    <span class="n">ih</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">sc2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sc2</span><span class="p">[</span><span class="n">ih</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            
                    <span class="c1">#calculate associated load vector for boundary conditions</span>
                    <span class="n">hs1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span>    <span class="c1"># original stresses</span>
                    <span class="n">hs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hs1</span><span class="p">)</span>      <span class="c1"># mirrored stresses</span>
                    <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hs1</span><span class="o">*</span><span class="n">hs2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># filter stress components where sign has changed by mirroring</span>
                    <span class="n">ubc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">sign</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="c1"># change sign accordingly in BC vector</span>

                    <span class="c1">#add mirrored data to flow stresses and augment plastic strain arrays accordingly</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span> <span class="o">*=</span> <span class="mi">2</span>    <span class="c1"># number of data points in raw data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scyl_raw</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">sc2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peeq_raw</span><span class="p">,</span> <span class="n">peeq_raw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ubc_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">ubc2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">sdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sig_</span>  <span class="o">=</span> <span class="n">sp_cart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span><span class="p">)</span> <span class="c1"># transform back into 3D principle stress space</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sig_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">sc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sig_</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">svoigt</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">evec</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeq_full</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ubc_</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sig_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            
                <span class="c1">#calculate yield function of raw data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f_yld_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span> <span class="o">-</span> <span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i_el_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_yld_</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i_pl_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_yld_</span><span class="o">&gt;=</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
                <span class="c1">#filter load cases for selected data around yield point</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lc_</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list of lists with data set indices belonging to one load case</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">uvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc_</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
                <span class="c1">#print(&#39;First load case: &#39;, uvec)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ubc_</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">uvec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">toler</span><span class="p">:</span>
                        <span class="n">hh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">lc_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span>
                            <span class="c1">#print(&#39;Load case selection&#39;, i, uvec, hh[0],hh[-1])</span>
                        <span class="n">uvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc_</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                        <span class="n">hh</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lc_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc_</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of load cases: &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span><span class="p">,</span> <span class="s1">&#39;; with &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span><span class="p">,</span> <span class="s1">&#39; data points around yield point&#39;</span><span class="p">)</span>

                <span class="c1">#for each load case: interpolate flow stress to fixed PEEQ</span>
                <span class="n">hs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># help array for equiv stress (seq) at yielding</span>
                <span class="n">ht</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># help array for polar angle (theta) at yielding</span>
                <span class="n">hv</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># help array for Voigt stress at yielding</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span><span class="p">):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">iel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_yld_</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># find elastic data sets in load case</span>
                    <span class="n">ipl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_yld_</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># find plastic data sets in load case</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iel</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ipl</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;**Load case&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;not enough data points around yield point. iel=&#39;</span><span class="p">,</span><span class="n">iel</span><span class="p">,</span><span class="s1">&#39;ipl=&#39;</span><span class="p">,</span><span class="n">ipl</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># difference in seq b/w first plastic and last elastic data point</span>
                        <span class="n">dseq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ipl</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># difference in full stress b/w first plastic and last elastic data point</span>
                        <span class="n">dsig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ipl</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># difference in peeq b/w first plastic and last elastic data point</span>
                        <span class="n">de</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ipl</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>  <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
                        <span class="c1"># difference in peeq b/w nominal yield strain and last elastic data point</span>
                        <span class="n">dint</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
                        <span class="c1"># linearly interpolated equiv. stress at yield onset</span>
                        <span class="n">hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dseq</span><span class="o">*</span><span class="n">dint</span><span class="o">/</span><span class="n">de</span><span class="p">)</span>
                        <span class="n">ht</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># polar angle of load case</span>
                        <span class="n">hv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],:]</span> <span class="o">+</span> <span class="n">dsig</span><span class="o">*</span><span class="n">dint</span><span class="o">/</span><span class="n">de</span><span class="p">)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span>   <span class="c1"># sort w.r.t. polar angle</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>   <span class="c1"># critical cylindrical stress tensor at yield onset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hs</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>   <span class="c1"># first component: seq</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ht</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>   <span class="c1"># second component: polar angle</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span><span class="mi">6</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syld</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hv</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>       <span class="c1"># full Voigt stress at yield onset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># refined value for yield strength of data set</span>
            
                <span class="c1">#select data points with eqiv. stress in range [0.1,0.4]sy =&gt; elastic constants</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq_J2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>
                <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">seq</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="p">,</span> <span class="n">seq</span><span class="o">&lt;</span><span class="mf">0.4</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">seq_J2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind1</span><span class="p">])</span>
                <span class="n">eeq</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="n">ind1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">seq</span><span class="o">/</span><span class="n">eeq</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="mf">0.3</span>
            
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated elastic constants: E=</span><span class="si">%5.2f</span><span class="s1"> GPa, nu=</span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated yield strength: </span><span class="si">%5.2f</span><span class="s1"> MPa, from </span><span class="si">%i</span><span class="s1"> data sets with PEEQ approx. </span><span class="si">%5.3f</span><span class="s1">&#39;</span> 
                      <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="p">))</span>
                <span class="k">if</span> <span class="s2">&quot;Prop_E&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Young&#39;s modulus provided in meta data:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;Prop_E&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s2">&quot;Prop_nu&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Poisson ratio provided in meta data:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;Prop_nu&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">plot_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>    </div>
   
<div class="viewcode-block" id="Data.Set_DB"><a class="viewcode-back" href="../pyLabFEA.html#data.Data.Set_DB">[docs]</a>    <span class="k">class</span> <span class="nc">Set_DB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Define class for handling of a dataset from a Mongo databse</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db   : object of type ``Data``</span>
<span class="sd">            Parent database from which properties are inherited</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of JSON file with metadata for microstructure to be stored in this dataset</span>
<span class="sd">        plot : Boolean</span>
<span class="sd">            Graphical output of data in each set (optional, default: False)</span>
<span class="sd">        </span>
<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        db : object of class ``Data``</span>
<span class="sd">        name : str</span>
<span class="sd">        N  : int</span>
<span class="sd">            Number of imported data points</span>
<span class="sd">        Ndat : int</span>
<span class="sd">            Number of raw data points (filtered data lying around yield point mirrored wrt polar angle)</span>
<span class="sd">        Nlc  : int</span>
<span class="sd">            Number of load cases in raw data</span>
<span class="sd">        E, nu : float</span>
<span class="sd">            Elastic parameters obtained from data</span>
<span class="sd">        sy    : float</span>
<span class="sd">            Yield strength obtained from data</span>
<span class="sd">        texture_param : float</span>
<span class="sd">            Microstructure parameter for texture</span>
<span class="sd">        eps, epl, eel, sig, ubc, sc_full : (N,) array</span>
<span class="sd">        sfc_   : (Ndat,3) array</span>
<span class="sd">            Filtered cyl. stress tensor around yield point</span>
<span class="sd">        peeq_  : (Ndat,) array</span>
<span class="sd">            Filtered equiv. plastic strain around yield point</span>
<span class="sd">        ubc_   : (Ndat,db.sdim) array</span>
<span class="sd">            Filtered boundary condition vector around yield point</span>
<span class="sd">        sig_   : (Ndat,db.sdim) array</span>
<span class="sd">            Filtered stress tensor around yield point (princ. stresses for sdim=3)</span>
<span class="sd">        f_yld_ : (Ndat,) array</span>
<span class="sd">            Categorial yield function of data points around yield point (&quot;-1&quot;: elastic, &quot;+1&quot;: plastic)</span>
<span class="sd">        i_el_  : (Ndat,) array</span>
<span class="sd">            Filtered indeces of data points lying in elastic regime</span>
<span class="sd">        i_pl_  : (Ndat,) array</span>
<span class="sd">            Filtered indeces for data points lying in plastic regime</span>
<span class="sd">        syc    : (Nlc,3) array</span>
<span class="sd">            Yield strength: interpolated cyl. stress tensor at onset of yielding for individual load cases</span>
<span class="sd">        load_case : list</span>
<span class="sd">            List of lists with data set indices belonging to one single load case from full data </span>
<span class="sd">            (index space: [0,N])</span>
<span class="sd">        lc_    : list</span>
<span class="sd">            List of lists with data set indices belonging to one single load case from filtered data </span>
<span class="sd">            around yield point (index space: [0,Ndat])</span>
<span class="sd">    </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;def prop_elastic():</span>
<span class="sd">                &#39;calculate estimates for elastic properties E, nu associated to data set&#39;</span>
<span class="sd">                ssig = 1.e-1</span>
<span class="sd">                seps = 1.e3</span>
<span class="sd">                a = seps*self.eps[ind,:]</span>
<span class="sd">                b = ssig*self.sig[ind,:]</span>
<span class="sd">                x = np.linalg.lstsq(a, b, rcond=None)</span>
<span class="sd">                c = x[0]*seps/ssig</span>
<span class="sd">                self.C11 = c[0,0]</span>
<span class="sd">                self.C12 = c[1,0]</span>
<span class="sd">                self.C13 = c[2,0]</span>
<span class="sd">                self.C21 = c[0,1]</span>
<span class="sd">                self.C22 = c[1,1]</span>
<span class="sd">                self.C23 = c[2,1]</span>
<span class="sd">                self.C31 = c[0,2]</span>
<span class="sd">                self.C32 = c[1,2]</span>
<span class="sd">                self.C33 = c[2,2]</span>
<span class="sd">                </span>
<span class="sd">                #self.nu = self.C12/(self.C11 + self.C12) # estimate for isotropic materials</span>
<span class="sd">                #self.E = self.C12*(1.+self.nu)*(1.-2.*self.nu)/self.nu</span>
<span class="sd">                </span>
<span class="sd">                print(&#39;Estimated elasic tensor C_ij (GPa): \n%8.2f, %8.2f, %8.2f&#39; </span>
<span class="sd">                       % (self.C11/1000, self.C12/1000, self.C13/1000))</span>
<span class="sd">                print(&#39;%8.2f, %8.2f, %8.2f&#39; </span>
<span class="sd">                       % (self.C21/1000, self.C22/1000, self.C23/1000))</span>
<span class="sd">                print(&#39;%8.2f, %8.2f, %8.2f&#39; </span>
<span class="sd">                       % (self.C31/1000, self.C32/1000, self.C33/1000))</span>
<span class="sd">                print(&#39;Residuals of fitting elastic parameters: &#39;,x[1])&#39;&#39;&#39;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
            <span class="n">eps_0</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">sig_0</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">epl_0</span> <span class="o">=</span> <span class="mf">0.</span>
        
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Incompatible data sets: Yield_Stress and Flow-Stress classes cannot be mixed.&#39;</span><span class="p">)</span>
            <span class="n">lpad</span> <span class="o">=</span> <span class="n">LaunchPad</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">pw</span><span class="p">)</span>
            <span class="n">fireworks_db</span><span class="o">=</span><span class="n">lpad</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;fireworks&quot;</span><span class="p">]</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s1">&#39;$lookup&#39;</span><span class="p">:</span> <span class="c1"># to joind</span>
                            <span class="p">{</span><span class="s1">&#39;from&#39;</span> <span class="p">:</span> <span class="s1">&#39;launches&#39;</span><span class="p">,</span>  <span class="c1"># with $launches collection</span>
                             <span class="s1">&#39;localField&#39;</span> <span class="p">:</span> <span class="s1">&#39;fw_id&#39;</span><span class="p">,</span> <span class="c1"># using the same &quot;fw_id&quot; in $fireworks collection</span>
                             <span class="s1">&#39;foreignField&#39;</span> <span class="p">:</span> <span class="s1">&#39;fw_id&#39;</span><span class="p">,</span> <span class="c1"># and in in $launches collection</span>
                             <span class="s1">&#39;as&#39;</span> <span class="p">:</span> <span class="s1">&#39;launches&#39;</span><span class="p">}</span>  <span class="c1"># and named it as $launches</span>
                        <span class="p">},</span>
                        
                        <span class="p">{</span><span class="s1">&#39;$unwind&#39;</span><span class="p">:</span> <span class="s1">&#39;$launches&#39;</span><span class="p">},</span> <span class="c1"># has to be so for convenience</span>
                        
                
                        <span class="p">{</span><span class="s1">&#39;$match&#39;</span><span class="p">:</span> <span class="c1"># filter only those entries, where</span>
                             <span class="p">{</span><span class="s1">&#39;state&#39;</span> <span class="p">:</span> <span class="s1">&#39;COMPLETED&#39;</span><span class="p">,</span>    <span class="c1"># $fireworks.state ==  COMPLETED </span>
                              <span class="s1">&#39;spec.material_inp_id&#39;</span> <span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="c1"># and  that have $fireworks.spec.material_inp_id==random</span>
                              <span class="s2">&quot;launches.action.update_spec.results_json&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span><span class="s2">&quot;true&quot;</span><span class="p">}</span> <span class="c1"># and for which the &quot;result_json&quot; exists</span>
                             <span class="p">}</span>
                        <span class="p">},</span>   
                        
                        <span class="c1"># how to rename the output data</span>
                        <span class="p">{</span><span class="s1">&#39;$project&#39;</span><span class="p">:</span> 
                            <span class="p">{</span>
                                <span class="s2">&quot;_id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># system field &quot;_id&quot; we don&#39;t need</span>
                                <span class="s1">&#39;fw_id&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># we need &quot;fw_id&quot; just for info</span>
                                <span class="s1">&#39;spec&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># we need complete &quot;spec&quot;</span>
                                <span class="s1">&#39;results_json&#39;</span><span class="p">:</span><span class="s1">&#39;$launches.action.update_spec.results_json&#39;</span> <span class="c1"># we need complete &quot;results_json&quot; from $launches.action.update_spec</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        
                       <span class="p">]</span>
            
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">fireworks_db</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
            <span class="n">joined_queried_data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;col_names = [&#39;S11&#39;,&#39;S22&#39;,&#39;S33&#39;,&#39;S12&#39;,&#39;S13&#39;,&#39;S23&#39;, \</span>
<span class="sd">                         &#39;Ee11&#39;,&#39;Ee22&#39;,&#39;Ee33&#39;,&#39;Ee12&#39;,&#39;Ee13&#39;,&#39;Ee23&#39;, \</span>
<span class="sd">                         &#39;Ep11&#39;,&#39;Ep22&#39;,&#39;Ep33&#39;,&#39;Ep12&#39;,&#39;Ep13&#39;,&#39;Ep23&#39;, \</span>
<span class="sd">                         &#39;E11&#39;,&#39;E22&#39;,&#39;E33&#39;,&#39;E12&#39;,&#39;E13&#39;,&#39;E23&#39;, \</span>
<span class="sd">                         &#39;F11&#39;,&#39;F22&#39;,&#39;F33&#39;,&#39;F23&#39;,&#39;F13&#39;,&#39;F12&#39;]&#39;&#39;&#39;</span>
            <span class="n">tot_df</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">joined_queried_data</span><span class="p">)</span>
            <span class="n">tot_df</span><span class="p">[</span><span class="s2">&quot;material_inp_id&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">tot_df</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;material_inp_id&quot;</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tot_df</span><span class="o">.</span><span class="n">results_json</span>
            <span class="sd">&#39;&#39;&#39;self.meta = {</span>
<span class="sd">                &#39;Class&#39;         : &#39;Flow_Stress&#39;,</span>
<span class="sd">                &#39;Texture_index&#39; : 1.0, </span>
<span class="sd">                &#39;Texture_name&#39;  : tot_df[&quot;material_inp_id&quot;][0],</span>
<span class="sd">                &#39;Texture_type&#39;  : tot_df[&quot;material_inp_id&quot;][0],</span>
<span class="sd">                &#39;Prop_E&#39;        : 151220.0,</span>
<span class="sd">                &#39;Prop_nu&#39;       : 0.3</span>
<span class="sd">                }&#39;&#39;&#39;</span>
            <span class="c1">#define texture parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">texture_param</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">texture_name</span>  <span class="o">=</span> <span class="n">tot_df</span><span class="p">[</span><span class="s2">&quot;material_inp_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">texture_type</span>  <span class="o">=</span> <span class="n">tot_df</span><span class="p">[</span><span class="s2">&quot;material_inp_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1">##################### header #############################</span>
            <span class="c1"># S : stress</span>
            <span class="c1"># Ee: elastic strain</span>
            <span class="c1"># Ep: plastic strain</span>
            <span class="c1"># E : total strain</span>
            <span class="c1"># F : force BC</span>
            <span class="c1"># S11,S22,S33,S12,S13,S23,</span>
            <span class="c1"># Ee11,Ee22,Ee33,Ee12,Ee13,Ee23,</span>
            <span class="c1"># Ep11,Ep22,Ep33,Ep12,Ep13,Ep23,</span>
            <span class="c1"># E11,E22,E33,E12,E13,E23,</span>
            <span class="c1"># F11,F22,F33,F23,F13,F12.</span>
            <span class="c1"># index: S : 0, 1, 2, 3, 4, 5,</span>
            <span class="c1">#        Ee: 6, 7, 8, 9,10,11,</span>
            <span class="c1">#        Ep:12,13,14,15,16,17,</span>
            <span class="c1">#        E :18,19,20,21,22,23</span>
            <span class="c1">#        F :24,25,26,27,28,29 </span>
            <span class="c1">########################################################</span>
            <span class="c1">#concatenate load cases for complete stress-strain data into arrays</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_case</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list of lists with data set indices belonging to one load case</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">ls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">istart</span><span class="p">,</span> <span class="n">istart</span><span class="o">+</span><span class="n">ls</span><span class="p">)))</span>
                <span class="n">istart</span> <span class="o">+=</span> <span class="n">ls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span>   <span class="o">=</span> <span class="n">istart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">istart</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">istart</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">istart</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">istart</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sel</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epl</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sel</span><span class="p">[:,</span><span class="mi">12</span><span class="p">:</span><span class="mi">12</span><span class="o">+</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sel</span><span class="p">[:,</span><span class="mi">18</span><span class="p">:</span><span class="mi">18</span><span class="o">+</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sel</span><span class="p">[:,</span><span class="mi">24</span><span class="p">:</span><span class="mi">24</span><span class="o">+</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">peeq_full</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epl</span><span class="p">)</span> <span class="c1">#calculate eqiv. plastic strains </span>
            
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">predef</span><span class="p">:</span>
                <span class="n">sig_0</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#self.sig -= sig_0</span>
                <span class="c1"># correct starting points for strains in case of pre-deformation</span>
                <span class="n">eps_0</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">-=</span> <span class="n">eps_0</span>
                <span class="n">epl_0</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epl</span> <span class="o">-=</span> <span class="n">epl_0</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">sdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span> <span class="o">=</span> <span class="n">s_cyl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>   <span class="c1"># transform pinc. stresses into cylindrical coordinates</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evec</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evec</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hsv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">):</span>
                    <span class="n">hso</span> <span class="o">=</span> <span class="n">Stress</span><span class="p">(</span><span class="n">hsv</span><span class="p">)</span>  <span class="c1"># define object of stress tensor</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">hso</span><span class="o">.</span><span class="n">cyl</span><span class="p">()</span> <span class="c1"># transform princ. stress into cylindrical stress</span>
                    <span class="c1"># store eigenvectors in form of rotation matrix from reference frame to princ. stress frame</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">evec</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span>  <span class="o">=</span> <span class="n">hso</span><span class="o">.</span><span class="n">evec</span>             

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*** Microstructure:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;***&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="s1">&#39; data points imported into database &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">flow_stress</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data for flow stresses at various plastic strains imported.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">predef</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">###Mechanical data obtained after predeformation.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial stress: &#39;</span><span class="p">,</span><span class="n">sig_0</span><span class="p">,</span> <span class="s1">&#39; equiv. stress: &#39;</span><span class="p">,</span> <span class="n">seq_J2</span><span class="p">(</span><span class="n">sig_0</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial total strain: &#39;</span><span class="p">,</span><span class="n">eps_0</span><span class="p">,</span> <span class="s1">&#39;equiv. total strain&#39;</span><span class="p">,</span> <span class="n">eps_eq</span><span class="p">(</span><span class="n">eps_0</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial plastic strain: &#39;</span><span class="p">,</span><span class="n">epl_0</span><span class="p">,</span> <span class="s1">&#39;equiv. plastic strain: &#39;</span><span class="p">,</span><span class="n">eps_eq</span><span class="p">(</span><span class="n">epl_0</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial values have been subtracted from stress-strain data.&#39;</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Texture &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">texture_name</span><span class="p">,</span> <span class="s1">&#39;with texture parameter: &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">texture_param</span><span class="p">)</span>
            
            <span class="c1">#Consistency checks</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="n">h1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">h2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;*** Warning: Large hydrostatic stresses: minimum p=&#39;</span><span class="o">+</span><span class="n">h1</span><span class="o">+</span><span class="s1">&#39; MPa, maximum p=&#39;</span><span class="o">+</span><span class="n">h2</span><span class="o">+</span><span class="s1">&#39; MPa&#39;</span><span class="p">)</span>

            <span class="c1">#data is provided for flow stress at various plastic strains</span>
            <span class="c1">#select data points close to yield point =&gt; yield strength sy and raw data for ML flow rule</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peeq_full</span><span class="o">&gt;</span><span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="o">-</span><span class="n">db</span><span class="o">.</span><span class="n">dep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeq_full</span><span class="o">&lt;</span><span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="o">+</span><span class="n">db</span><span class="o">.</span><span class="n">dep</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;***Warning: too few data points around yield criterion:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;, &#39;</span>\
                              <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dep</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="n">scyl_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">scyl_raw</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># get first estimate of yield point, will be refined later</span>
        
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">mirror</span><span class="p">:</span>
                <span class="c1">#mirror stress data at yield point</span>
                <span class="n">hs2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">,:])</span>
                <span class="c1">#calculate associated load vector for boundary conditions</span>
                <span class="n">ubc2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="p">,:])</span> <span class="c1"># change sign accordingly in BC vector</span>
                <span class="n">peeq_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeq_full</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="c1">#add mirrored data to flow stresses and augment plastic strain arrays accordingly</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span> <span class="o">*=</span> <span class="mi">2</span>    <span class="c1"># number of data points in raw data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span> <span class="n">hs2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span>  <span class="o">=</span> <span class="n">s_cyl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peeq_raw</span><span class="p">,</span> <span class="n">peeq_raw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ubc_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">ubc2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc_full</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeq_full</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ubc_</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        
            <span class="c1">#calculate yield function of raw data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_yld_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span> <span class="o">-</span> <span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_el_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_yld_</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_pl_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_yld_</span><span class="o">&gt;=</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
            <span class="c1">#filter load cases for selected data around yield point</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc_</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list of lists with data set indices belonging to one load case</span>
            <span class="n">hh</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc_</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="c1">#print(&#39;First load case: &#39;, uvec)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ubc_</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">uvec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.e-4</span><span class="p">:</span>
                    <span class="n">hh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lc_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span>
                    <span class="n">uvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ubc_</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                    <span class="n">hh</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lc_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc_</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of load cases: &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span><span class="p">,</span> <span class="s1">&#39;; with &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span><span class="p">,</span> <span class="s1">&#39; data points around yield point&#39;</span><span class="p">)</span>

            <span class="c1">#for each load case: interpolate flow stress to fixed PEEQ</span>
            <span class="n">hs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># help array for equiv stress (seq) at yielding</span>
            <span class="n">ht</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># help array for polar angle (theta) at yielding</span>
            <span class="n">hv</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># help array for Voigt stress at yielding</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">iel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_yld_</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># find elastic data sets in load case</span>
                <span class="n">ipl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_yld_</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># find plastic data sets in load case</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iel</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ipl</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;**Load case&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;not enough data points around yield point. iel=&#39;</span><span class="p">,</span><span class="n">iel</span><span class="p">,</span><span class="s1">&#39;ipl=&#39;</span><span class="p">,</span><span class="n">ipl</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># difference in seq b/w first plastic and last elastic data point</span>
                    <span class="n">dseq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ipl</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># difference in full stress b/w first plastic and last elastic data point</span>
                    <span class="n">dsig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ipl</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># difference in peeq b/w first plastic and last elastic data point</span>
                    <span class="n">de</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ipl</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>  <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
                    <span class="c1"># difference in peeq b/w nominal yield strain and last elastic data point</span>
                    <span class="n">dint</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">peeq_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
                    <span class="c1"># linearly interpolated equiv. stress at yield onset</span>
                    <span class="n">hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dseq</span><span class="o">*</span><span class="n">dint</span><span class="o">/</span><span class="n">de</span><span class="p">)</span>
                    <span class="n">ht</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># polar angle of load case</span>
                    <span class="n">hv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">iel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],:]</span> <span class="o">+</span> <span class="n">dsig</span><span class="o">*</span><span class="n">dint</span><span class="o">/</span><span class="n">de</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span>   <span class="c1"># sort w.r.t. polar angle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>   <span class="c1"># critical cylindrical stress tensor at yield onset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hs</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>   <span class="c1"># first component: seq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ht</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>   <span class="c1"># second component: polar angle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span><span class="mi">6</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syld</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">db</span><span class="o">.</span><span class="n">sdim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hv</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>       <span class="c1"># full Voigt stress at yield onset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># refined value for yield strength of data set</span>
        
            <span class="c1">#select data points with eqiv. stress in range [0.1,0.4]sy =&gt; elastic constants</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">seq_J2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>
            <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">seq</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="p">,</span> <span class="n">seq</span><span class="o">&lt;</span><span class="mf">0.4</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">seq_J2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind1</span><span class="p">])</span>
            <span class="n">eeq</span> <span class="o">=</span> <span class="n">eps_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="n">ind1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">seq</span><span class="o">/</span><span class="n">eeq</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="mf">0.3</span>
        
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated elastic constants: E=</span><span class="si">%5.2f</span><span class="s1"> GPa, nu=</span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated yield strength: </span><span class="si">%5.2f</span><span class="s1"> MPa, from </span><span class="si">%i</span><span class="s1"> data sets with PEEQ approx. </span><span class="si">%5.3f</span><span class="s1">&#39;</span> 
                  <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sy</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">epc</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">plot_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Data.Set_Data"><a class="viewcode-back" href="../pyLabFEA.html#data.Data.Set_Data">[docs]</a>    <span class="k">class</span> <span class="nc">Set_Data</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate set from input data&#39;&#39;&#39;</span>
        
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="c1">#data provided only for stress tensor at yield point</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">mirror</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="o">-</span><span class="n">sig</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syc</span>  <span class="o">=</span> <span class="n">s_cyl</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>   <span class="c1"># critical cylindrical stress tensor at yield onset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syld</span> <span class="o">=</span> <span class="n">sig</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sy</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># average value for yield strength of data set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nlc</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ndat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">texture_type</span> <span class="o">=</span> <span class="s1">&#39;Goss-100%&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">texture_param</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">texture_name</span> <span class="o">=</span><span class="s1">&#39;Goss&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="mf">151220.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="mf">0.3</span></div>
        
<div class="viewcode-block" id="Data.plot_yield_locus"><a class="viewcode-back" href="../pyLabFEA.html#data.Data.plot_yield_locus">[docs]</a>    <span class="k">def</span> <span class="nf">plot_yield_locus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">set_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">arrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Plot yield loci of imported microstructures in database.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        active  : str</span>
<span class="sd">            &#39;flow_stress&#39;, &#39;work_hard&#39; or &#39;texture&#39;, selct which parameter to vary for set of plots</span>
<span class="sd">        set_ind : int</span>
<span class="sd">            select data set for work hardening plots (corresponds to level of plastic strain) (optional, default: 0)</span>
<span class="sd">        scatter : Boolean</span>
<span class="sd">            defines if raw data points are plotted (optional, default: False)</span>
<span class="sd">        data : (N,3) or (N,2) array</span>
<span class="sd">            additional data to plot in form of cylindrical stresses (optional, default: None)</span>
<span class="sd">        data_label : str</span>
<span class="sd">            label for legend of additional data (optional, default: None)</span>
<span class="sd">        arrow : Boolean</span>
<span class="sd">            indicate if arrows for principal stress directions are drawn (optional, default: False)</span>
<span class="sd">        file   : str</span>
<span class="sd">            filename for output (optional, default: None (no output))</span>
<span class="sd">        title  : str</span>
<span class="sd">            title for plot (optional, default: None)</span>
<span class="sd">        fontsize : int</span>
<span class="sd">            specifies fontsize used in plot (optional, default: 18)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="c1">#ms_max = np.amax(self.mat_param[active])</span>
        <span class="n">Ndat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="n">active</span><span class="p">])</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="n">active</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="n">active</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1.e-3</span><span class="p">):</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ndat</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="n">active</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">hc</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="o">-</span><span class="n">v0</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span>
            <span class="k">if</span> <span class="n">active</span><span class="o">==</span><span class="s1">&#39;work_hard&#39;</span><span class="p">:</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="s1">&#39;flow_stress&#39;</span><span class="p">][</span><span class="n">set_ind</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="n">s_cyl</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># sort dta points w.r.t. polar angle</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;PEEQ: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">hc</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">active</span><span class="o">==</span><span class="s1">&#39;texture&#39;</span><span class="p">:</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="s1">&#39;flow_stress&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdim</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="n">s_cyl</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># sort dta points w.r.t. polar angle</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">texture_name</span>
                <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">hc</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">hc</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">active</span><span class="o">==</span><span class="s1">&#39;flow_stress&#39;</span><span class="p">:</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="s1">&#39;flow_stress&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">polar</span><span class="p">(</span><span class="n">sc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">sc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;.r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;shear&#39;</span><span class="p">)</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat_param</span><span class="p">[</span><span class="s1">&#39;flow_stress&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Flow Stress&#39;</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Undefined value for active field in &quot;plot_yield_locus&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scatter</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">polar</span><span class="p">(</span><span class="n">sc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">sc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;.m&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">polar</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;.r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">data_label</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">polar</span><span class="p">(</span><span class="n">sc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">sc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">1.04</span><span class="p">,</span><span class="mf">0.7</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arrow</span><span class="p">:</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sy_av</span>
            <span class="n">drh</span> <span class="o">=</span> <span class="mf">0.08</span><span class="o">*</span><span class="n">dr</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> 
                     <span class="n">head_length</span><span class="o">=</span><span class="n">drh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">dr</span><span class="o">*</span><span class="mf">0.87</span><span class="p">,</span> <span class="s1">&#39;$\sigma_1$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mf">2.0944</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                     <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="n">drh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2.26</span><span class="p">,</span> <span class="n">dr</span><span class="o">*</span><span class="mf">0.92</span><span class="p">,</span> <span class="s1">&#39;$\sigma_2$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0944</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                     <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="n">drh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">2.04</span><span class="p">,</span> <span class="n">dr</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;$\sigma_3$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="Data.plot_set"><a class="viewcode-back" href="../pyLabFEA.html#data.Data.plot_set">[docs]</a>    <span class="k">def</span> <span class="nf">plot_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nth</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Graphical output of equiv. stress vs. equic. total strain for selected load cases and </span>
<span class="sd">        raw data in deviatoric cyl. stress space</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : str</span>
<span class="sd">            Write graph to pdf file (optional)</span>
<span class="sd">        nth  : int</span>
<span class="sd">            Plot every nth load case (optional, default: 18)</span>
<span class="sd">        fontsize : 20</span>
<span class="sd">            Fontsize for plot (optional, default: 20)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">load_case</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">nth</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">load_case</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">polar_ang</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eps_eq</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">seq_J2</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">col</span><span class="p">))</span> <span class="c1">#&#39;.k&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\epsilon_</span><span class="si">{eq}</span><span class="s1">^\mathrm</span><span class="si">{tot}</span><span class="s1">$ (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma_</span><span class="si">{eq}</span><span class="s1">$ (MPa)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Equiv. total strain vs. equiv. J2 stress&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#, projection=&#39;polar&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">dset</span><span class="o">.</span><span class="n">i_pl_</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dset</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">dset</span><span class="o">.</span><span class="n">i_pl_</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;or&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">dset</span><span class="o">.</span><span class="n">i_el_</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dset</span><span class="o">.</span><span class="n">sfc_</span><span class="p">[</span><span class="n">dset</span><span class="o">.</span><span class="n">i_el_</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ob&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dset</span><span class="o">.</span><span class="n">syc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;-k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span> <span class="p">[</span><span class="n">dset</span><span class="o">.</span><span class="n">sy</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">sy</span><span class="p">],</span> <span class="s1">&#39;--k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;raw data above yield point&#39;</span><span class="p">,</span> <span class="s1">&#39;raw data below yield point&#39;</span><span class="p">,</span> 
                       <span class="s1">&#39;interpolated yield strength&#39;</span><span class="p">,</span> <span class="s1">&#39;average yield strength&#39;</span><span class="p">],</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">1.04</span><span class="p">,</span><span class="mf">0.8</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Raw data &#39;</span><span class="o">+</span><span class="n">dset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\theta$ (rad)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma_</span><span class="si">{eq}</span><span class="s1">$ (MPa)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file</span><span class="o">+</span><span class="n">dset</span><span class="o">.</span><span class="n">texture_name</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>

 
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">pyLabFEA</a></h1>








<h3>Navigation</h3>
<p><span class="caption-text">Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Technical guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyLabFEA.html">Modules</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Alexander Hartmaier, ICAMS/Ruhr University Bochum, Germany.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>